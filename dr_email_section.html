<!-- Email Templates Section -->
<div class="section-card">
    <div class="section-header">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
        <h3>Templates de E-mail</h3>
    </div>
    
    <div style="background: #f0f9fb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-[#009cb6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-sm font-medium text-[#009cb6]">Personalizar emails por idioma</p>
        </div>
        <p class="text-xs text-gray-600 mb-1">ParÃ¢metros disponÃ­veis:</p>
        <div class="flex flex-wrap gap-2 text-xs">
            <code class="px-2 py-1 bg-white border border-gray-200 rounded">{drNumber}</code>
            <code class="px-2 py-1 bg-white border border-gray-200 rounded">{firstName}</code>
            <code class="px-2 py-1 bg-white border border-gray-200 rounded">{contractNumber}</code>
            <code class="px-2 py-1 bg-white border border-gray-200 rounded">{vehiclePlate}</code>
            <code class="px-2 py-1 bg-white border border-gray-200 rounded">{date}</code>
            <code class="px-2 py-1 bg-white border border-gray-200 rounded">{email}</code>
        </div>
    </div>
    
    <!-- Language Tabs -->
    <div class="flex gap-2 mb-4 border-b border-gray-200">
        <button id="tabPT" onclick="switchEmailLang('pt')" class="email-lang-tab active">
            ðŸ‡µðŸ‡¹ PortuguÃªs
        </button>
        <button id="tabEN" onclick="switchEmailLang('en')" class="email-lang-tab">
            ðŸ‡¬ðŸ‡§ English
        </button>
        <button id="tabFR" onclick="switchEmailLang('fr')" class="email-lang-tab">
            ðŸ‡«ðŸ‡· FranÃ§ais
        </button>
        <button id="tabDE" onclick="switchEmailLang('de')" class="email-lang-tab">
            ðŸ‡©ðŸ‡ª Deutsch
        </button>
    </div>
    
    <!-- Email Form -->
    <div id="emailTemplateForm">
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Assunto</label>
            <input type="text" id="emailSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" 
                   placeholder="Damage Report {drNumber} - {vehiclePlate}">
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Corpo do Email</label>
            <textarea id="emailBody" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm font-mono" 
                      placeholder="Hello {firstName},&#10;&#10;Please find attached the Damage Report nÂº {drNumber}..."></textarea>
        </div>
        
        <button onclick="saveEmailTemplate()" 
                class="w-full flex items-center justify-center gap-2 bg-[#009cb6] text-white px-4 py-2 rounded-md hover:bg-[#007a8f] transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
            </svg>
            <span>Guardar Template</span>
        </button>
    </div>
</div>

<style>
.email-lang-tab {
    padding: 8px 16px;
    border: none;
    background: none;
    cursor: pointer;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.email-lang-tab:hover {
    color: #009cb6;
}

.email-lang-tab.active {
    color: #009cb6;
    border-bottom-color: #009cb6;
}
</style>

<script>
let currentEmailLang = 'pt';
let emailTemplates = {};

// Load all templates on page load
async function loadEmailTemplates() {
    try {
        const response = await fetch('/api/damage-reports/email-templates');
        const data = await response.json();
        
        if (data.ok) {
            data.templates.forEach(tpl => {
                emailTemplates[tpl.language_code] = {
                    subject: tpl.subject_template,
                    body: tpl.body_template
                };
            });
            
            // Load current language
            loadCurrentEmailTemplate();
        }
    } catch (error) {
        console.error('Error loading email templates:', error);
    }
}

function switchEmailLang(lang) {
    // Save current template before switching
    saveCurrentTemplateToMemory();
    
    // Update active tab
    document.querySelectorAll('.email-lang-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(`tab${lang.toUpperCase()}`).classList.add('active');
    
    currentEmailLang = lang;
    loadCurrentEmailTemplate();
}

function saveCurrentTemplateToMemory() {
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;
    
    emailTemplates[currentEmailLang] = { subject, body };
}

function loadCurrentEmailTemplate() {
    const template = emailTemplates[currentEmailLang] || { subject: '', body: '' };
    
    document.getElementById('emailSubject').value = template.subject;
    document.getElementById('emailBody').value = template.body;
}

async function saveEmailTemplate() {
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;
    
    if (!subject || !body) {
        showNotification('Preencha o assunto e o corpo do email', 'warning');
        return;
    }
    
    const languageNames = {
        'pt': 'PortuguÃªs',
        'en': 'English',
        'fr': 'FranÃ§ais',
        'de': 'Deutsch'
    };
    
    try {
        const response = await fetch(`/api/damage-reports/email-template/${currentEmailLang}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                language_name: languageNames[currentEmailLang],
                subject_template: subject,
                body_template: body
            })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            showNotification(`Template ${languageNames[currentEmailLang]} guardado com sucesso`, 'success');
            emailTemplates[currentEmailLang] = { subject, body };
        } else {
            showNotification('Erro ao guardar template: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error saving email template:', error);
        showNotification('Erro ao guardar template', 'error');
    }
}

// Load templates when page loads
document.addEventListener('DOMContentLoaded', () => {
    loadEmailTemplates();
});
</script>
