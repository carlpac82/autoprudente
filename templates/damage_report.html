<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="cache-control" content="no-cache">
    <meta name="expires" content="0">
    <title>RelatÃ³rio de Danos - Auto Prudente v2.7-UPDATE-FIX</title>
    <link rel="stylesheet" href="/static/css/styles.css?v=2.7">
    <script src="/static/notifications.js?v=2.7"></script>
    <script>
        // Force cache bypass - v2.7-UPDATE-FIX
        const jsVersion = '2.7-UPDATE-FIX-202511090205';
        console.log('ðŸ”„ JavaScript Version:', jsVersion, '- Loaded at:', new Date().toISOString());
        console.log('âœ… Damage photos NOW WORKING in preview!');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Hide header if in iframe
        if (window.location.search.includes('iframe=1')) {
            document.addEventListener('DOMContentLoaded', function() {
                const header = document.querySelector('.header');
                if (header) header.style.display = 'none';
                
                // Adjust container padding
                const container = document.querySelector('.container');
                if (container) container.style.padding = '10px';
            });
        }
    </script>
    <style>
        body {
            background: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .header {
            background: white;
            color: #1f2937;
            padding: 15px 0;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .header h1 {
            margin: 0;
            margin-left: 20px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 15px;
            border-left: 4px solid #f4ad0f;
        }
        
        .fullscreen-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .fullscreen-btn:hover {
            border-color: #009cb6;
            background: #f0f9fb;
        }
        
        .fullscreen-btn svg {
            width: 20px;
            height: 20px;
            stroke: #6b7280;
            stroke-width: 1.5;
        }
        
        .fullscreen-btn:hover svg {
            stroke: #009cb6;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn:hover {
            background: #f9fafb;
            color: #009cb6;
        }
        
        .tab-btn.active {
            color: #009cb6;
            border-bottom-color: #009cb6;
            background: #f0f9fb;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 20px;
            color: #1f2937;
        }
        
        .icon-mono {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }
        
        /* Barra amarela APENAS no tÃ­tulo principal (h1) - removida de h2/h3 */
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="number"] {
            text-transform: none;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #009cb6;
            box-shadow: 0 0 0 3px rgba(0, 156, 182, 0.1);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #009cb6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #007a8f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 156, 182, 0.3);
        }
        
        /* Submit Button - Azul website com hover/active amarelo */
        #submitButton {
            background-color: #009cb6 !important;
            border-color: #009cb6 !important;
        }
        
        #submitButton:hover {
            background-color: #f6b511 !important;
            border-color: #f6b511 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(246, 181, 17, 0.3);
        }
        
        #submitButton:active {
            background-color: #f6b511 !important;
            border-color: #f6b511 !important;
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white;
            color: #6b7280;
            border: 2px solid #6b7280;
        }
        
        .btn-secondary:hover {
            background: #6b7280;
            color: white;
        }
        
        .btn-success {
            background: white;
            color: #10b981;
            border: 2px solid #10b981;
        }
        
        .btn-success:hover {
            background: #10b981;
            color: white;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #009cb6;
            background: #f0f9fb;
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        /* CROQUI DO CARRO */
        .car-diagram-container {
            background: #f9fafb;
            border-radius: 12px;
            padding: 30px;
        }
        
        .car-view {
            position: relative;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .car-view h3 {
            text-align: center;
            color: #6b7280;
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        
        .car-svg-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .car-svg {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .damage-pin {
            position: absolute;
            width: 40px;
            height: 56px;
            background-image: url('/static/pin.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom;  /* âœ… Pin alinhado ao fundo */
            display: flex;
            align-items: flex-start;  /* âœ… NÃºmero no topo (bola do pin) */
            justify-content: center;
            padding-top: 16px;  /* âœ… Ajustado para 16px (nÃºmero mais BAIXO, correspondendo a 35% = ~20px do fundo) */
            color: #000000;  /* âœ… PRETO PURO (nÃ£o cinza) */
            font-weight: 900;
            font-size: 24px;  /* âœ… MAIOR: 24px (era 20px) */
            cursor: pointer;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
            transform: translate(-50%, -100%);  /* âœ… Ponta do pin na posiÃ§Ã£o clicada */
            transform-origin: bottom center;  /* âœ… Ponto de referÃªncia na ponta do pin */
            transition: all 0.2s;
            pointer-events: auto;  /* âœ… Garantir clique em toda Ã¡rea */
        }
        
        .damage-pin:hover {
            filter: drop-shadow(0 4px 16px rgba(255, 0, 0, 0.4));  /* Sombra vermelha no hover */
        }
        
        /* âœ… Ponto visual na ponta do pin (hover) para confirmar posicionamento */
        .damage-pin::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: rgba(255, 0, 0, 0);  /* InvisÃ­vel por padrÃ£o */
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .damage-pin:hover::after {
            background: rgba(255, 0, 0, 0.8);  /* Ponto vermelho visÃ­vel no hover */
            width: 6px;
            height: 6px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }
        
        .damage-list {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .damage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .damage-item:last-child {
            margin-bottom: 0;
        }
        
        .damage-number {
            width: 28px;
            height: 28px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }
        
        .damage-detail-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .damage-detail-row:hover {
            border-color: #009cb6;
            background: #f0f9fb;
        }
        
        .damage-detail-number {
            width: 40px;
            height: 40px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .damage-detail-input {
            flex: 1;
        }
        
        .damage-detail-input input {
            width: 100%;
            padding: 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .damage-detail-input input:focus {
            outline: none;
            border-color: #009cb6;
            box-shadow: 0 0 0 3px rgba(0, 156, 182, 0.1);
        }
        
        .damage-detail-delete {
            flex-shrink: 0;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header style="background: #009cb6; border-bottom: 1px solid rgba(0,0,0,0.1);">
        <div style="max-width: 1200px; margin: 0 auto; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <a href="/" style="display: inline-flex; align-items: center;" title="Homepage">
                    <img src="/static/ap-heather.png" alt="Auto Prudente" style="height: 48px; width: auto;" />
                </a>
            </div>
            
            <div style="display: flex; align-items: center; gap: 12px;">
                <a href="/" style="padding: 8px; color: rgba(255,255,255,0.9); text-decoration: none; border-radius: 6px; transition: all 0.2s;" title="Homepage" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                </a>
                <a href="/price-history" style="padding: 8px; color: rgba(255,255,255,0.9); text-decoration: none; border-radius: 6px; transition: all 0.2s;" title="HistÃ³rico de PreÃ§os" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </a>
                <a href="/price-automation" style="padding: 8px; color: rgba(255,255,255,0.9); text-decoration: none; border-radius: 6px; transition: all 0.2s;" title="AutomaÃ§Ã£o de PreÃ§os" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </a>
                <a href="/damage-report" style="padding: 8px; color: white; background: rgba(255,255,255,0.2); text-decoration: none; border-radius: 6px; transition: all 0.2s;" title="Damage Report">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </a>
                <a href="/admin" style="padding: 8px; color: rgba(255,255,255,0.9); text-decoration: none; border-radius: 6px; transition: all 0.2s;" title="Settings" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Page Header -->
        <div class="header">
            <h1>RelatÃ³rio de Danos</h1>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div style="display: flex; border-bottom: 2px solid #e5e7eb;">
                <button class="tab-btn active" onclick="switchTab('form')" id="formTab">
                    <svg class="icon-mono" style="width: 18px; height: 18px;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Criar Damage Report
                </button>
                <button class="tab-btn" onclick="switchTab('preview')" id="previewTab">
                    <svg class="icon-mono" style="width: 18px; height: 18px;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Preview em Tempo Real
                </button>
                <button class="tab-btn" onclick="switchTab('history')" id="historyTab">
                    <svg class="icon-mono" style="width: 18px; height: 18px;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    HistÃ³rico
                </button>
            </div>
        </div>

        <!-- Tab Content: FormulÃ¡rio -->
        <div id="formContent" class="tab-content active">
        
            <!-- Upload Rental Agreement -->
            <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 24px;">
                <div style="width: 48px; height: 48px; background: #e0f2f7; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg style="width: 28px; height: 28px; color: #009cb6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 15px; color: #1a1a1a; margin-bottom: 4px;">Upload Rental Agreement</div>
                    <div style="font-size: 13px; color: #6b7280;">
                        <span id="raFilename">Extrair dados do cliente e veÃ­culo automaticamente</span>
                    </div>
                </div>
                
                <button type="button" onclick="document.getElementById('raFile').click()" 
                        title="Selecionar ficheiro"
                        onmouseover="this.style.background='#009cb6'; this.style.borderColor='#009cb6';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';"
                        style="width: 48px; height: 48px; background: white; border: 2px solid #d1d5db; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s;">
                    <svg style="width: 24px; height: 24px; color: #009cb6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                </button>
                <input type="file" id="raFile" accept=".pdf" onchange="handleRAUpload(event)" style="display: none;">
            </div>
        
        <form id="damageReportForm">
            <!-- Dados do Contrato -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h2>Dados do Contrato</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>NÃºmero de Contrato *</label>
                        <input type="text" id="contractNumber" name="contractNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                </div>
            </div>

            <!-- Dados do Cliente -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <h2>Dados do Cliente</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="clientName" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" name="clientEmail">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="clientPhone" name="clientPhone">
                    </div>
                    <div class="form-group">
                        <label>Morada</label>
                        <input type="text" id="address" name="address">
                    </div>
                    <div class="form-group">
                        <label>CÃ³digo Postal / Cidade</label>
                        <input type="text" id="postalCodeCity" name="postalCodeCity" placeholder="1000-001 / Lisboa">
                    </div>
                    <div class="form-group">
                        <label>PaÃ­s</label>
                        <input type="text" id="country" name="country">
                    </div>
                </div>
            </div>

            <!-- Dados do VeÃ­culo -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                    <h2>Dados do VeÃ­culo</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>MatrÃ­cula *</label>
                        <input type="text" id="vehiclePlate" name="vehiclePlate" required>
                    </div>
                    <div class="form-group">
                        <label>Marca / Modelo *</label>
                        <input type="text" id="vehicleBrandModel" name="vehicleBrandModel" placeholder="Volkswagen / Golf" required>
                    </div>
                </div>
            </div>

            <!-- Datas de Levantamento e DevoluÃ§Ã£o -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <h2>Levantamento e DevoluÃ§Ã£o</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Data de Levantamento</label>
                        <input type="date" id="pickupDate" name="pickupDate">
                    </div>
                    <div class="form-group">
                        <label>Hora de Levantamento</label>
                        <input type="time" id="pickupTime" name="pickupTime">
                    </div>
                    <div class="form-group">
                        <label>Local de Levantamento</label>
                        <input type="text" id="pickupLocation" name="pickupLocation" value="AUTO PRUDENTE">
                    </div>
                    <div class="form-group">
                        <label>Data de DevoluÃ§Ã£o</label>
                        <input type="date" id="returnDate" name="returnDate">
                    </div>
                    <div class="form-group">
                        <label>Hora de DevoluÃ§Ã£o</label>
                        <input type="time" id="returnTime" name="returnTime">
                    </div>
                    <div class="form-group">
                        <label>Local de DevoluÃ§Ã£o</label>
                        <input type="text" id="returnLocation" name="returnLocation" value="AUTO PRUDENTE">
                    </div>
                </div>
            </div>

            <!-- Feito por / Issued by -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <h2>Feito por / Issued by</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do FuncionÃ¡rio / Employee Name</label>
                        <input type="text" id="issuedBy" name="issuedBy" readonly style="background: #f9fafb; cursor: not-allowed;">
                    </div>
                </div>
            </div>

            <!-- Croqui do Carro -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #ef4444;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <h2>Croqui de Danos</h2>
                </div>
                
                <div class="car-diagram-container">
                    <div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <label style="font-weight: 600; color: #374151; min-width: 120px;">Tamanho do Pin:</label>
                            <input type="range" id="pinSizeSlider" min="0.5" max="2" step="0.1" value="1" style="flex: 1;">
                            <span id="pinSizeValue" style="font-weight: 600; color: #009cb6; min-width: 50px; text-align: center;">100%</span>
                        </div>
                        <p style="color: #6b7280; margin: 0; font-size: 13px;">
                            ðŸ’¡ Clique no carro para adicionar pins de danos. Clique no pin para remover. Ajuste o tamanho antes de marcar.
                        </p>
                    </div>
                    
                    <div class="car-view">
                        <div class="car-svg-container" id="carDiagram" onclick="addDamagePin(event, 'all')" style="position: relative;">
                            <img src="/static/images/Croqui.png" alt="Croqui do Carro" style="width: 100%; height: auto; display: block; max-width: 1000px; margin: 0 auto;">
                        </div>
                    </div>
                    
                    <div class="damage-list" id="damageList" style="display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Danos Registados:</h4>
                        <div id="damageItems"></div>
                    </div>
                </div>
            </div>


            <!-- Danos na Viatura -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #ef4444;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <h2>Danos na Viatura / Vehicle Damage</h2>
                </div>
                
                <div id="damageDetailsContainer" style="display: none;">
                    <p style="color: #6b7280; margin-bottom: 15px; font-size: 14px;">
                        ðŸ’¡ Cada nÃºmero do croqui corresponde a uma linha abaixo. Descreva o dano em detalhe.
                    </p>
                    <div id="damageDetailsList"></div>
                </div>
                
                <div id="noDamagesMessage" style="text-align: center; padding: 30px; color: #6b7280;">
                    <svg style="width: 48px; height: 48px; margin: 0 auto 15px; color: #d1d5db;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p style="margin: 0; font-size: 16px;">Nenhum dano marcado no croqui</p>
                    <p style="margin: 10px 0 0 0; font-size: 14px;">Clique no croqui acima para adicionar pins de danos</p>
                </div>
            </div>

            <!-- Detalhes de ReparaÃ§Ã£o / Repair Details -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <h2>Detalhes de ReparaÃ§Ã£o / Repair Details</h2>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600; color: #374151;">Detalhes de ReparaÃ§Ã£o</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: 600; color: #374151; width: 100px;">Quantidades</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: 600; color: #374151; width: 100px;">Horas</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600; color: #374151; width: 120px;">PreÃ§o (â‚¬)</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600; color: #374151; width: 120px;">Total (â‚¬)</th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; width: 60px;">
                                    <button type="button" class="btn btn-primary" onclick="addRepairRow()" style="padding: 6px 12px; font-size: 12px;">+</button>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="repairTableBody">
                            <tr>
                                <td colspan="6" style="padding: 20px; text-align: center; color: #6b7280; border: 1px solid #e5e7eb;">
                                    Clique no botÃ£o + para adicionar itens de reparaÃ§Ã£o
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr style="background: #f9fafb; font-weight: bold;">
                                <td colspan="4" style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; color: #374151;">TOTAL:</td>
                                <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; color: #009cb6; font-size: 18px;" id="repairTotal">0.00 â‚¬</td>
                                <td style="border: 1px solid #e5e7eb;"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Imagens do Dano / Damage Images -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <h2>Imagens do Dano / Damage Images (MÃ¡x. 9)</h2>
                </div>
                
                <div style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('imageUploadInput').click()">
                            <svg class="icon-mono" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Adicionar Imagem
                        </button>
                        <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)" multiple>
                        <span style="margin-left: 10px; color: #6b7280; font-size: 13px;" id="imageCount">0 / 9 imagens</span>
                    </div>
                    
                    <div id="imageGallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        <!-- Imagens serÃ£o adicionadas aqui -->
                    </div>
                </div>
            </div>

            <!-- BotÃµes -->
            <div class="action-buttons">
                <button type="button" class="btn btn-secondary" onclick="clearForm()" title="Limpar formulÃ¡rio" style="width: 48px; height: 48px; padding: 12px; border-radius: 8px;">
                    <svg class="icon-mono" style="width: 24px; height: 24px;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadPDF()" id="downloadBtn" title="Download PDF" style="display: none; width: 48px; height: 48px; padding: 12px; border-radius: 8px;">
                    <svg class="icon-mono" style="width: 24px; height: 24px;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </button>
                <button type="submit" class="btn" id="submitButton" title="Criar Damage Report com PDF" style="width: 48px; height: 48px; padding: 12px; border-radius: 8px; background-color: #10b981; border-color: #10b981; color: white; transition: all 0.2s;">
                    <svg class="icon-mono" style="width: 24px; height: 24px;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </button>
            </div>
        </form>
        </div>

        <!-- Tab Content: Preview em Tempo Real -->
        <div id="previewContent" class="tab-content">
            <div class="card">
                <div style="padding: 15px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #374151; font-size: 16px;">ðŸ“„ Preview do Damage Report</h3>
                    <button type="button" class="btn btn-primary" onclick="updatePDFPreview()" style="padding: 8px 16px; font-size: 13px;">
                        <svg class="icon-mono" style="width: 16px; height: 16px;" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Atualizar Preview
                    </button>
                </div>
                <div id="livePreview" style="padding: 0; min-height: 800px; background: #525659;">
                    <p style="text-align: center; color: #9ca3af; padding: 60px 20px; font-size: 15px;">
                        ðŸ“‹ Preencha o formulÃ¡rio e clique em "Atualizar Preview" para ver o PDF original preenchido
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab Content: HistÃ³rico -->
        <div id="historyContent" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #009cb6;">ðŸ“‹ Damage Reports Criados</h2>
                    <button type="button" class="btn btn-primary" onclick="loadHistory()">
                        <svg class="icon-mono" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Atualizar
                    </button>
                </div>
                <div id="historyList" style="max-height: 600px; overflow-y: auto;">
                    <p style="text-align: center; color: #6b7280; padding: 30px;">
                        ðŸ”„ Carregando histÃ³rico...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="max-width: 700px; margin: 50px auto; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #009cb6 0%, #007a8f 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Enviar Damage Report por Email</h2>
                </div>
                <button onclick="closeEmailModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Body -->
            <div style="padding: 25px;">
                <!-- Email do Cliente -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">Email do Cliente</label>
                    <input type="email" id="emailRecipient" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; transition: all 0.2s;" placeholder="cliente@exemplo.com" onfocus="this.style.borderColor='#009cb6'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                
                <!-- Preview do Assunto -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">Assunto</label>
                    <div id="emailSubjectPreview" style="padding: 10px 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; color: #6b7280;">
                        A carregar...
                    </div>
                </div>
                
                <!-- Preview do Corpo (suporta HTML) -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">Mensagem (Preview)</label>
                    <iframe id="emailBodyPreview" style="width: 100%; height: 400px; border: 2px solid #e5e7eb; border-radius: 6px; background: white;">
                    </iframe>
                </div>
                
                <!-- Lista de Anexos -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">Anexos</label>
                    <div id="emailAttachmentsList" style="padding: 12px; background: #f0f9fb; border: 2px solid #009cb6; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px; color: #009cb6; font-size: 13px;">
                            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                            <span id="attachmentInfo">Damage Report PDF</span>
                        </div>
                        <!-- Anexos Adicionais -->
                        <div id="additionalAttachmentsList" style="margin-top: 12px; display: none;">
                            <!-- Lista de arquivos adicionados dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Adicionar Anexos Adicionais -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">Adicionar Outros Anexos</label>
                    <input type="file" id="additionalAttachmentsInput" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;" onchange="handleAdditionalAttachments(event)">
                    <button onclick="document.getElementById('additionalAttachmentsInput').click()" style="padding: 10px 16px; background: white; color: #009cb6; border: 2px dashed #009cb6; border-radius: 6px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; width: 100%;" onmouseover="this.style.background='#f0f9fb'" onmouseout="this.style.background='white'">
                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>Adicionar Anexos (PDF, Imagens, Word)</span>
                    </button>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">MÃ¡ximo 5 arquivos, 10MB cada</p>
                </div>
                
                <!-- BotÃµes -->
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeEmailModal()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                        Cancelar
                    </button>
                    <button id="sendEmailBtn" onclick="sendDREmail()" style="padding: 10px 24px; background: #009cb6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.background='#007a8f'" onmouseout="this.style.background='#009cb6'">
                        <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        <span>Enviar Email</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let damageCounter = 0;
        let damages = [];
        let currentDRNumber = null;
        let repairItems = [];
        let currentPinSize = 1.0; // Tamanho padrÃ£o do pin
        
        // FunÃ§Ã£o para atualizar tamanho de todos os pins em tempo real
        function updateAllPinsSize() {
            const pins = document.querySelectorAll('.damage-pin');
            pins.forEach(pin => {
                pin.style.transform = `translate(-50%, -100%) scale(${currentPinSize})`;
            });
        }
        
        // Atualizar valor do slider de tamanho do pin
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('pinSizeSlider');
            const value = document.getElementById('pinSizeValue');
            
            if (slider && value) {
                slider.addEventListener('input', function() {
                    currentPinSize = parseFloat(this.value);
                    value.textContent = Math.round(currentPinSize * 100) + '%';
                    
                    // âœ… ATUALIZAR TODOS OS PINS EM TEMPO REAL
                    updateAllPinsSize();
                });
            }
            
            // âœ… AUTO-FILL DATA COM DATA ATUAL (mas permitir editar)
            const dateInput = document.getElementById('date');
            if (dateInput && !dateInput.value) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
                console.log('ðŸ“… Data auto-preenchida:', dateInput.value);
            }
        });
        let damageImages = [];

        // Manipular upload de imagens de danos individuais
        async function handleImageUpload(event) {
            const files = event.target.files;
            
            if (damageImages.length + files.length > 9) {
                showNotification('MÃ¡ximo de 9 imagens permitidas', 'error');
                return;
            }
            
            for (let file of files) {
                if (damageImages.length >= 9) break;
                
                // Ler imagem
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Mostrar modal de redimensionamento
                        showResizeModal(img, file.name);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // Limpar input
            event.target.value = '';
        }
        
        // Mostrar modal de redimensionamento
        function showResizeModal(img, filename) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;';
            
            content.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #374151;">Redimensionar e Ajustar Imagem</h3>
                <div style="text-align: center; margin-bottom: 20px; position: relative; overflow: hidden; border: 1px solid #e5e7eb; background: #f9fafb; max-height: 400px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="resizeCanvas" style="max-width: 100%; max-height: 400px; cursor: move; display: block;"></canvas>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Largura (px):</label>
                    <input type="range" id="widthSlider" min="100" max="${img.width}" value="${Math.min(800, img.width)}" style="width: 100%;">
                    <span id="widthValue" style="color: #6b7280;">${Math.min(800, img.width)}px</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Zoom:</label>
                    <input type="range" id="zoomSlider" min="50" max="200" value="100" style="width: 100%;">
                    <span id="zoomValue" style="color: #6b7280;">100%</span>
                </div>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <button onclick="resetImagePosition()" class="btn btn-secondary" style="padding: 8px 16px;">
                        <svg class="icon-mono" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Resetar PosiÃ§Ã£o
                    </button>
                    <span style="color: #6b7280; font-size: 13px;">Arraste a imagem para ajustar a posiÃ§Ã£o</span>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="this.closest('div').parentElement.parentElement.remove()" class="btn btn-secondary">Cancelar</button>
                    <button onclick="saveResizedImage()" class="btn btn-primary">Adicionar</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Configurar canvas
            const canvas = document.getElementById('resizeCanvas');
            const ctx = canvas.getContext('2d');
            const slider = document.getElementById('widthSlider');
            const widthValue = document.getElementById('widthValue');
            const zoomSlider = document.getElementById('zoomSlider');
            const zoomValue = document.getElementById('zoomValue');
            
            // VariÃ¡veis de controle
            let currentWidth = Math.min(800, img.width);
            let zoom = 1.0;
            let offsetX = 0;
            let offsetY = 0;
            let isDragging = false;
            let startX, startY;
            
            // FunÃ§Ã£o para desenhar imagem com zoom e pan
            function drawImage() {
                const ratio = img.height / img.width;
                let width = currentWidth;
                let height = currentWidth * ratio;
                
                // Limitar altura a 400px
                const maxHeight = 400;
                if (height > maxHeight) {
                    height = maxHeight;
                    width = height / ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                
                // Aplicar zoom e offset
                const scaledWidth = width * zoom;
                const scaledHeight = height * zoom;
                const x = (width - scaledWidth) / 2 + offsetX;
                const y = (height - scaledHeight) / 2 + offsetY;
                
                ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                ctx.restore();
                
                widthValue.textContent = Math.round(width) + 'px';
                zoomValue.textContent = Math.round(zoom * 100) + '%';
            }
            
            // Desenhar inicial
            drawImage();
            
            // Atualizar ao mover slider de largura
            slider.oninput = (e) => {
                currentWidth = parseInt(e.target.value);
                drawImage();
            };
            
            // Atualizar ao mover slider de zoom
            zoomSlider.oninput = (e) => {
                zoom = parseInt(e.target.value) / 100;
                drawImage();
            };
            
            // Drag para mover imagem
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX - offsetX;
                startY = e.clientY - offsetY;
                canvas.style.cursor = 'grabbing';
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    offsetX = e.clientX - startX;
                    offsetY = e.clientY - startY;
                    drawImage();
                }
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.style.cursor = 'move';
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
                canvas.style.cursor = 'move';
            });
            
            // FunÃ§Ã£o para resetar posiÃ§Ã£o
            window.resetImagePosition = () => {
                offsetX = 0;
                offsetY = 0;
                zoom = 1.0;
                zoomSlider.value = 100;
                drawImage();
            };
            
            // Salvar funÃ§Ã£o globalmente
            window.saveResizedImage = () => {
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        damageImages.push({
                            id: Date.now(),
                            data: e.target.result,
                            name: filename
                        });
                        updateImageGallery();
                        modal.remove();
                        showNotification('Imagem adicionada com sucesso!', 'success');
                    };
                    reader.readAsDataURL(blob);
                }, 'image/jpeg', 0.9);
            };
        }
        
        // Atualizar galeria de imagens
        function updateImageGallery() {
            const gallery = document.getElementById('imageGallery');
            const imageCount = document.getElementById('imageCount');
            
            imageCount.textContent = `${damageImages.length} / 9 imagens`;
            
            if (damageImages.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">Nenhuma imagem adicionada</p>';
                return;
            }
            
            gallery.innerHTML = damageImages.map(img => `
                <div style="position: relative; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <img src="${img.data}" style="width: 100%; height: 200px; object-fit: cover;">
                    <button onclick="removeImage(${img.id})" style="position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    <div style="padding: 8px; background: rgba(0,0,0,0.7); color: white; font-size: 11px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${img.name}</div>
                </div>
            `).join('');
        }
        
        // Remover imagem
        function removeImage(id) {
            damageImages = damageImages.filter(img => img.id !== id);
            updateImageGallery();
            showNotification('Imagem removida', 'info');
        }

        // Carregar nome do utilizador logado
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/current-user');
                if (response.ok) {
                    const data = await response.json();
                    if (data.full_name) {
                        document.getElementById('issuedBy').value = data.full_name.toUpperCase();
                    }
                }
            } catch (error) {
                console.error('Error loading current user:', error);
            }
        }

        // Carregar utilizador atual
        loadCurrentUser();
        
        // Check URL parameters for tab
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        if (tabParam) {
            switchTab(tabParam);
        }
        
        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            if (event.data.action === 'showMapperOnly') {
                // Force switch to mapper tab
                switchTab('mapper');
                
                // Hide other tabs if in iframe
                if (window.location.search.includes('iframe=1')) {
                    const tabs = document.querySelectorAll('.tab-btn');
                    tabs.forEach(tab => {
                        if (!tab.id.includes('mapper')) {
                            tab.style.display = 'none';
                        }
                    });
                }
            }
        });

        // Abrir em fullscreen
        function openFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
        }
        
        // Trocar tabs
        function switchTab(tabName) {
            // Remover active de todos os botÃµes e conteÃºdos
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar tab selecionada
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.getElementById(tabName + 'Content').classList.add('active');
            
            // Se for preview, atualizar
            if (tabName === 'preview') {
                updateLivePreview();
            }
            
            // Se for histÃ³rico, carregar
            if (tabName === 'history') {
                loadHistory();
            }
            
            // Se for mapper, carregar PDF
            if (tabName === 'mapper') {
                loadPDFMapper();
            }
        }
        
        // ============ MAPPER DE CAMPOS ============
        
        const FIELDS_TO_MAP = [
            { id: 'dr_number', name: 'DR NÂº (topo direita)', type: 'text' },
            { id: 'date', name: 'Data (topo direita)', type: 'text' },
            { id: 'client_name', name: 'Nome Completo do Cliente', type: 'text' },
            { id: 'client_email', name: 'Email do Cliente', type: 'text' },
            { id: 'client_phone', name: 'Telefone do Cliente', type: 'text' },
            { id: 'client_address', name: 'Morada do Cliente', type: 'text' },
            { id: 'client_postal_code', name: 'CÃ³digo Postal', type: 'text' },
            { id: 'client_city', name: 'Cidade', type: 'text' },
            { id: 'client_country', name: 'PaÃ­s', type: 'text' },
            { id: 'vehicle_plate', name: 'MatrÃ­cula', type: 'text' },
            { id: 'vehicle_brand', name: 'Marca', type: 'text' },
            { id: 'vehicle_model', name: 'Modelo', type: 'text' },
            { id: 'pickup_date', name: 'Data de Levantamento', type: 'text' },
            { id: 'pickup_time', name: 'Hora de Levantamento', type: 'text' },
            { id: 'pickup_location', name: 'Local de Levantamento', type: 'text' },
            { id: 'return_date', name: 'Data de DevoluÃ§Ã£o', type: 'text' },
            { id: 'return_time', name: 'Hora de DevoluÃ§Ã£o', type: 'text' },
            { id: 'return_location', name: 'Local de DevoluÃ§Ã£o', type: 'text' },
            { id: 'issued_by', name: 'Feito por / Issued by', type: 'text' },
            { id: 'damage_description', name: 'DescriÃ§Ã£o dos Danos (Ã¡rea de texto)', type: 'textarea' },
            { id: 'vehicle_damage_image', name: 'Imagem do VeÃ­culo com Danos', type: 'image' },
            { id: 'repair_table_header', name: 'Tabela ReparaÃ§Ã£o - CabeÃ§alho', type: 'table' },
            { id: 'repair_line_1', name: 'Detalhes da ReparaÃ§Ã£o - Linha 1', type: 'table' },
            { id: 'repair_line_2', name: 'Detalhes da ReparaÃ§Ã£o - Linha 2', type: 'table' },
            { id: 'repair_line_3', name: 'Detalhes da ReparaÃ§Ã£o - Linha 3', type: 'table' },
            { id: 'repair_line_4', name: 'Detalhes da ReparaÃ§Ã£o - Linha 4', type: 'table' },
            { id: 'repair_line_5', name: 'Detalhes da ReparaÃ§Ã£o - Linha 5', type: 'table' },
            { id: 'repair_total', name: 'Tabela ReparaÃ§Ã£o - Total', type: 'table' },
            { id: 'images_area', name: 'Ãrea de Imagens (atÃ© 9 fotos)', type: 'images' }
        ];
        
        let currentFieldIndex = 0;
        let fieldCoordinates = {};
        let pdfImageData = null;
        let canvas = null;
        let ctx = null;
        let scale = 1;
        let currentPage = 1;
        let totalPages = 2;
        let pdfDoc = null;
        let copiedBox = null;
        
        async function loadPDFMapper() {
            canvas = document.getElementById('pdfCanvas');
            ctx = canvas.getContext('2d');
            
            // Carregar PDF com grid
            const response = await fetch('/static/damage_report_with_grid.pdf');
            const blob = await response.blob();
            
            // Converter PDF para imagem usando PDF.js
            const url = URL.createObjectURL(blob);
            const loadingTask = pdfjsLib.getDocument(url);
            pdfDoc = await loadingTask.promise;
            totalPages = pdfDoc.numPages;
            
            // Renderizar pÃ¡gina atual
            await renderPage(currentPage);
            
            // Adicionar eventos de mouse
            canvas.onmousedown = onCanvasClick;
            canvas.onmousemove = onCanvasMouseMove;
            canvas.onmouseup = onCanvasMouseUp;
            canvas.style.cursor = 'crosshair';
            
            // Popular dropdown de campos
            populateFieldSelector();
            
            // Mostrar primeiro campo
            updateCurrentField();
            updateMappedFieldsList();
            updatePageButtons();
        }
        
        function populateFieldSelector() {
            const selector = document.getElementById('fieldSelector');
            
            // Limpar opÃ§Ãµes existentes (exceto a primeira)
            selector.innerHTML = '<option value="">-- Escolhe um campo --</option>';
            
            // Adicionar todos os campos
            FIELDS_TO_MAP.forEach((field, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                // Ãcone conforme tipo
                let icon = 'ðŸ“';
                if (field.type === 'textarea') icon = 'ðŸ“„';
                else if (field.type === 'table') icon = 'ðŸ“Š';
                else if (field.type === 'image') icon = 'ðŸ–¼ï¸';
                else if (field.type === 'images') icon = 'ðŸ“¸';
                
                // Marcar se jÃ¡ estÃ¡ mapeado
                const isMapped = fieldCoordinates[field.id] ? ' âœ“' : '';
                
                option.textContent = `${icon} ${field.name}${isMapped}`;
                option.style.color = isMapped ? '#10b981' : '#1f2937';
                
                selector.appendChild(option);
            });
        }
        
        function selectFieldManually() {
            const selector = document.getElementById('fieldSelector');
            const selectedIndex = parseInt(selector.value);
            
            if (isNaN(selectedIndex)) {
                return;
            }
            
            currentFieldIndex = selectedIndex;
            updateCurrentField();
            
            // Ir para a pÃ¡gina correta se o campo jÃ¡ estiver mapeado
            const field = FIELDS_TO_MAP[currentFieldIndex];
            const coord = fieldCoordinates[field.id];
            if (coord && coord.page !== currentPage) {
                currentPage = coord.page;
                renderPage(currentPage);
                updatePageButtons();
            }
        }
        
        async function renderPage(pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            
            const viewport = page.getViewport({ scale: 2 });
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            scale = viewport.scale;
            
            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;
            
            // Guardar imagem do PDF para redesenhar rapidamente
            pdfImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Redesenhar caixas da pÃ¡gina atual
            redrawMappedBoxes();
            
            document.getElementById('canvasInfo').textContent = 
                `PÃ¡gina ${pageNum} | Tamanho: ${(viewport.width / 28.35).toFixed(1)} x ${(viewport.height / 28.35).toFixed(1)} cm`;
            
            document.getElementById('pageInfo').textContent = `PÃ¡gina ${pageNum} / ${totalPages}`;
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
                updatePageButtons();
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderPage(currentPage);
                updatePageButtons();
            }
        }
        
        function updatePageButtons() {
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
        }
        
        let isDragging = false;
        let startX, startY;
        let currentBox = null;
        
        function onCanvasClick(event) {
            if (currentFieldIndex >= FIELDS_TO_MAP.length) {
                showNotification('Todos os campos jÃ¡ foram mapeados!', 'info');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = (event.clientX - rect.left) * (canvas.width / rect.width);
            const y = (event.clientY - rect.top) * (canvas.height / rect.height);
            
            if (!isDragging) {
                // ComeÃ§ar a desenhar caixa
                isDragging = true;
                startX = x;
                startY = y;
                canvas.style.cursor = 'crosshair';
            }
        }
        
        function onCanvasMouseMove(event) {
            if (!isDragging || !pdfImageData) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (event.clientX - rect.left) * (canvas.width / rect.width);
            const y = (event.clientY - rect.top) * (canvas.height / rect.height);
            
            // Redesenhar PDF da imagem guardada
            ctx.putImageData(pdfImageData, 0, 0);
            
            // Redesenhar caixas jÃ¡ mapeadas
            redrawMappedBoxes();
            
            // Desenhar caixa temporÃ¡ria
            ctx.strokeStyle = 'rgba(0, 156, 182, 0.8)';
            ctx.fillStyle = 'rgba(0, 156, 182, 0.2)';
            ctx.lineWidth = 3;
            
            const width = x - startX;
            const height = y - startY;
            
            ctx.fillRect(startX, startY, width, height);
            ctx.strokeRect(startX, startY, width, height);
            
            // Mostrar dimensÃµes
            ctx.fillStyle = 'white';
            ctx.strokeStyle = '#009cb6';
            ctx.lineWidth = 2;
            ctx.font = 'bold 14px Arial';
            const text = `${Math.abs(width / scale / 28.35).toFixed(1)} x ${Math.abs(height / scale / 28.35).toFixed(1)} cm`;
            ctx.strokeText(text, startX + 5, startY - 10);
            ctx.fillText(text, startX + 5, startY - 10);
        }
        
        function redrawMappedBoxes() {
            // Redesenhar todas as caixas jÃ¡ mapeadas da pÃ¡gina atual
            FIELDS_TO_MAP.forEach(field => {
                const coord = fieldCoordinates[field.id];
                if (coord && coord.page === currentPage) {
                    const x = coord.x * scale;
                    const y = canvas.height - (coord.y * scale);
                    const w = coord.width * scale;
                    const h = coord.height * scale;
                    
                    // Cores diferentes por tipo
                    let strokeColor = '#009cb6';
                    let fillColor = 'rgba(0, 156, 182, 0.3)';
                    let labelColor = '#009cb6';
                    
                    if (field.type === 'textarea') {
                        strokeColor = '#8b5cf6'; // Roxo
                        fillColor = 'rgba(139, 92, 246, 0.2)';
                        labelColor = '#8b5cf6';
                    } else if (field.type === 'table') {
                        strokeColor = '#f59e0b'; // Laranja
                        fillColor = 'rgba(245, 158, 11, 0.2)';
                        labelColor = '#f59e0b';
                    } else if (field.type === 'image') {
                        strokeColor = '#10b981'; // Verde
                        fillColor = 'rgba(16, 185, 129, 0.2)';
                        labelColor = '#10b981';
                    } else if (field.type === 'images') {
                        strokeColor = '#ec4899'; // Rosa
                        fillColor = 'rgba(236, 72, 153, 0.2)';
                        labelColor = '#ec4899';
                    }
                    
                    // Caixa
                    ctx.strokeStyle = strokeColor;
                    ctx.fillStyle = fillColor;
                    ctx.lineWidth = 2;
                    ctx.fillRect(x, y - h, w, h);
                    ctx.strokeRect(x, y - h, w, h);
                    
                    // Label
                    ctx.fillStyle = labelColor;
                    ctx.fillRect(x, y - h - 20, Math.min(100, w), 20);
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 11px Arial';
                    ctx.fillText(field.id, x + 5, y - h - 6);
                }
            });
        }
        
        function onCanvasMouseUp(event) {
            if (!isDragging) return;
            
            const rect = canvas.getBoundingClientRect();
            const endX = (event.clientX - rect.left) * (canvas.width / rect.width);
            const endY = (event.clientY - rect.top) * (canvas.height / rect.height);
            
            // Converter para coordenadas PDF (pontos)
            const x1Pdf = Math.min(startX, endX) / scale;
            const y1Pdf = (canvas.height - Math.max(startY, endY)) / scale; // Inverter Y
            const x2Pdf = Math.max(startX, endX) / scale;
            const y2Pdf = (canvas.height - Math.min(startY, endY)) / scale; // Inverter Y
            
            const widthPdf = x2Pdf - x1Pdf;
            const heightPdf = y2Pdf - y1Pdf;
            
            // SÃ³ guardar se a caixa tiver tamanho mÃ­nimo
            if (Math.abs(widthPdf) > 10 && Math.abs(heightPdf) > 5) {
                const field = FIELDS_TO_MAP[currentFieldIndex];
                fieldCoordinates[field.id] = { 
                    x: x1Pdf, 
                    y: y1Pdf,
                    width: widthPdf,
                    height: heightPdf,
                    page: currentPage
                };
                
                // Desenhar caixa final
                ctx.strokeStyle = '#009cb6';
                ctx.fillStyle = 'rgba(0, 156, 182, 0.3)';
                ctx.lineWidth = 2;
                ctx.fillRect(Math.min(startX, endX), Math.min(startY, endY), 
                           Math.abs(endX - startX), Math.abs(endY - startY));
                ctx.strokeRect(Math.min(startX, endX), Math.min(startY, endY), 
                             Math.abs(endX - startX), Math.abs(endY - startY));
                
                // Label
                ctx.fillStyle = '#009cb6';
                ctx.fillRect(Math.min(startX, endX), Math.min(startY, endY) - 20, 
                           Math.min(100, Math.abs(endX - startX)), 20);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 11px Arial';
                ctx.fillText(field.id, Math.min(startX, endX) + 5, Math.min(startY, endY) - 6);
                
                // PrÃ³ximo campo nÃ£o mapeado
                currentFieldIndex++;
                // Pular campos jÃ¡ mapeados
                while (currentFieldIndex < FIELDS_TO_MAP.length && 
                       fieldCoordinates[FIELDS_TO_MAP[currentFieldIndex].id]) {
                    currentFieldIndex++;
                }
                
                updateCurrentField();
                updateMappedFieldsList();
                populateFieldSelector(); // Atualizar dropdown
                
                showNotification(`${field.name} mapeado com sucesso!`, 'success');
            } else {
                showNotification('Caixa muito pequena, tenta novamente', 'warning');
            }
            
            isDragging = false;
            canvas.style.cursor = 'crosshair';
        }
        
        function updateCurrentField() {
            const currentFieldName = document.getElementById('currentFieldName');
            const fieldProgress = document.getElementById('fieldProgress');
            const selector = document.getElementById('fieldSelector');
            
            // Sincronizar dropdown
            selector.value = currentFieldIndex < FIELDS_TO_MAP.length ? currentFieldIndex : '';
            
            if (currentFieldIndex < FIELDS_TO_MAP.length) {
                const field = FIELDS_TO_MAP[currentFieldIndex];
                
                // Mostrar tipo de campo com Ã­cone
                let icon = 'ðŸ“';
                let instruction = 'Arrasta para criar caixa';
                
                if (field.type === 'textarea') {
                    icon = 'ðŸ“„';
                    instruction = 'Arrasta Ã¡rea de texto (mÃºltiplas linhas)';
                } else if (field.type === 'table') {
                    icon = 'ðŸ“Š';
                    instruction = 'Arrasta Ã¡rea COMPLETA da tabela';
                } else if (field.type === 'image') {
                    icon = 'ðŸ–¼ï¸';
                    instruction = 'Arrasta Ã¡rea para diagrama/desenho';
                } else if (field.type === 'images') {
                    icon = 'ðŸ“¸';
                    instruction = 'Arrasta Ã¡rea para galeria de imagens';
                }
                
                currentFieldName.innerHTML = `${icon} ${field.name}<br><small style="font-size: 12px; font-weight: normal; color: #6b7280;">${instruction}</small>`;
            } else {
                currentFieldName.innerHTML = 'âœ… Todos os campos mapeados!<br><small style="font-size: 12px; font-weight: normal; color: #6b7280;">Clica "Guardar Coordenadas"</small>';
            }
            
            fieldProgress.textContent = `${Object.keys(fieldCoordinates).length} / ${FIELDS_TO_MAP.length} campos`;
        }
        
        function updateMappedFieldsList() {
            const list = document.getElementById('mappedFieldsList');
            
            if (Object.keys(fieldCoordinates).length === 0) {
                list.innerHTML = '<p style="color: #9ca3af; text-align: center;">Nenhum campo mapeado ainda</p>';
                return;
            }
            
            let html = '';
            FIELDS_TO_MAP.forEach(field => {
                const coord = fieldCoordinates[field.id];
                if (coord) {
                    // Cor da borda conforme tipo
                    let borderColor = '#009cb6';
                    let bgColor = '#f0f9fb';
                    
                    if (field.type === 'textarea') {
                        borderColor = '#8b5cf6';
                        bgColor = '#f5f3ff';
                    } else if (field.type === 'table') {
                        borderColor = '#f59e0b';
                        bgColor = '#fffbeb';
                    } else if (field.type === 'image') {
                        borderColor = '#10b981';
                        bgColor = '#f0fdf4';
                    } else if (field.type === 'images') {
                        borderColor = '#ec4899';
                        bgColor = '#fdf2f8';
                    }
                    
                    html += `
                        <div style="padding: 8px; margin-bottom: 5px; background: ${bgColor}; border-radius: 4px; border-left: 3px solid ${borderColor};">
                            <div style="font-weight: 600; color: #1f2937; font-size: 12px;">${field.name} <span style="background: ${borderColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">PÃ¡g ${coord.page}</span></div>
                            <div style="color: #6b7280; font-size: 10px; margin-top: 3px;">
                                ðŸ“ X: ${coord.x.toFixed(1)} pt (${(coord.x / 28.35).toFixed(1)} cm)<br>
                                ðŸ“ Y: ${coord.y.toFixed(1)} pt (${(coord.y / 28.35).toFixed(1)} cm)<br>
                                ðŸ“ ${coord.width.toFixed(1)} x ${coord.height.toFixed(1)} pt 
                                (${(coord.width / 28.35).toFixed(1)} x ${(coord.height / 28.35).toFixed(1)} cm)
                            </div>
                        </div>
                    `;
                }
            });
            
            list.innerHTML = html;
        }
        
        function skipCurrentField() {
            if (currentFieldIndex < FIELDS_TO_MAP.length) {
                currentFieldIndex++;
                // Pular campos jÃ¡ mapeados
                while (currentFieldIndex < FIELDS_TO_MAP.length && 
                       fieldCoordinates[FIELDS_TO_MAP[currentFieldIndex].id]) {
                    currentFieldIndex++;
                }
                updateCurrentField();
                populateFieldSelector();
                showNotification('â­ï¸ Campo pulado', 'info');
            }
        }
        
        function previousField() {
            if (currentFieldIndex > 0) {
                const field = FIELDS_TO_MAP[currentFieldIndex];
                
                // Se o campo atual jÃ¡ estÃ¡ mapeado, apagar
                if (fieldCoordinates[field.id]) {
                    delete fieldCoordinates[field.id];
                    updateMappedFieldsList();
                    populateFieldSelector();
                    showNotification('â¬…ï¸ Campo desmapeado', 'info');
                } else {
                    // SenÃ£o, voltar ao campo anterior
                    currentFieldIndex--;
                    updateCurrentField();
                    showNotification('â¬…ï¸ Campo anterior', 'info');
                }
                
                // Redesenhar
                ctx.putImageData(pdfImageData, 0, 0);
                redrawMappedBoxes();
            }
        }
        
        async function saveFieldCoordinates() {
            if (Object.keys(fieldCoordinates).length === 0) {
                showNotification('Nenhum campo foi mapeado!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/damage-reports/save-coordinates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fieldCoordinates)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showNotification(`${Object.keys(fieldCoordinates).length} coordenadas guardadas com sucesso!`, 'success');
                    
                    // Notificar parent window se estiver em iframe
                    if (window.parent !== window) {
                        window.parent.postMessage({ type: 'coordinatesSaved', count: result.count }, '*');
                    }
                } else {
                    showNotification('Erro ao guardar: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('Erro ao guardar coordenadas', 'error');
                console.error(error);
            }
        }
        
        // ============ COPIAR E COLAR CAIXAS ============
        
        function copyLastBox() {
            // Copiar a Ãºltima caixa mapeada
            const mappedFields = Object.keys(fieldCoordinates);
            if (mappedFields.length === 0) {
                showNotification('Nenhuma caixa para copiar!', 'warning');
                return;
            }
            
            const lastFieldId = mappedFields[mappedFields.length - 1];
            copiedBox = { ...fieldCoordinates[lastFieldId] };
            
            // Ativar botÃ£o de colar
            document.getElementById('pasteBtn').disabled = false;
            
            showNotification(`ðŸ“‹ Caixa copiada! (${copiedBox.width.toFixed(0)} x ${copiedBox.height.toFixed(0)} pt)`, 'success');
        }
        
        function pasteBox() {
            if (!copiedBox) {
                showNotification('Nenhuma caixa copiada!', 'warning');
                return;
            }
            
            if (currentFieldIndex >= FIELDS_TO_MAP.length) {
                showNotification('Todos os campos jÃ¡ foram mapeados!', 'warning');
                return;
            }
            
            // Colar no centro do canvas
            const centerX = canvas.width / (2 * scale);
            const centerY = canvas.height / (2 * scale);
            
            const field = FIELDS_TO_MAP[currentFieldIndex];
            fieldCoordinates[field.id] = {
                x: centerX - copiedBox.width / 2,
                y: centerY - copiedBox.height / 2,
                width: copiedBox.width,
                height: copiedBox.height,
                page: currentPage
            };
            
            // Redesenhar
            ctx.putImageData(pdfImageData, 0, 0);
            redrawMappedBoxes();
            
            // PrÃ³ximo campo nÃ£o mapeado
            currentFieldIndex++;
            // Pular campos jÃ¡ mapeados
            while (currentFieldIndex < FIELDS_TO_MAP.length && 
                   fieldCoordinates[FIELDS_TO_MAP[currentFieldIndex].id]) {
                currentFieldIndex++;
            }
            
            updateCurrentField();
            updateMappedFieldsList();
            populateFieldSelector();
            
            showNotification('Caixa colada! Ajusta a posiÃ§Ã£o se necessÃ¡rio', 'success');
        }
        
        // Atualizar preview com PDF original preenchido (v2.0 - Fixed missing fields)
        async function updatePDFPreview() {
            try {
                const formData = new FormData(document.getElementById('damageReportForm'));
                const data = Object.fromEntries(formData);
                
                // âœ… ADICIONAR CAMPOS QUE NÃƒO ESTÃƒO NO FORM - V2.0 FIXED
                console.log('ðŸ”ðŸ”ðŸ” INÃCIO V2.0 - Adicionando campos extras ao data...');
                console.log('   FormData original:', Object.keys(data).length, 'campos');
                
                // DR Number (gerado automaticamente)
                console.log('   currentDRNumber global:', currentDRNumber);
                if (currentDRNumber) {
                    data.drNumber = currentDRNumber;
                    console.log('   âœ… DR Number adicionado:', currentDRNumber);
                } else {
                    console.warn('   âš ï¸ DR Number nÃ£o definido - serÃ¡ gerado ao salvar');
                    // NÃƒO gerar DR temporÃ¡rio - deixar vazio para preview
                    // O nÃºmero DR sÃ³ deve aparecer DEPOIS de salvar/criar
                    data.drNumber = '';  // Vazio - mostra apenas "DR" no template
                    console.log('   â„¹ï¸ DR Number deixado vazio (serÃ¡ gerado ao salvar)');
                }
                
                // Data de inspeÃ§Ã£o (campo date)
                const dateField = document.getElementById('date');
                console.log('   dateField elemento:', dateField, '| valor:', dateField?.value);
                if (dateField && dateField.value) {
                    data.date = dateField.value;
                    console.log('   âœ… Date adicionado:', dateField.value);
                } else {
                    console.warn('   âš ï¸ Date vazio ou campo nÃ£o encontrado');
                }
                
                // Damage Diagram Data (pins JSON)
                console.log('   damages array:', damages, '| length:', damages?.length);
                if (damages && damages.length > 0) {
                    data.damageDiagramData = JSON.stringify(damages);
                    console.log('   âœ… Damage pins JSON adicionado:', damages.length, 'pins');
                    console.log('   Preview JSON:', data.damageDiagramData.substring(0, 100) + '...');
                } else {
                    console.warn('   âš ï¸ Nenhum pin de dano adicionado ao diagrama');
                }
                
                console.log('ðŸ” FIM - Data completo a enviar:', Object.keys(data).length, 'campos');
                console.log('   Campos incluÃ­dos:', Object.keys(data).join(', '));
                
                // Mostrar loading
                const preview = document.getElementById('livePreview');
                preview.innerHTML = '<p style="text-align: center; color: #009cb6; padding: 60px; font-size: 15px;">â³ Capturando diagrama...</p>';
                
                // Capturar o diagrama da viatura com pins como imagem
                console.log('ðŸš— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ðŸš— TENTANDO CAPTURAR DIAGRAMA DO CARRO...');
                const carDiagram = document.getElementById('carDiagram');
                console.log('   carDiagram elemento:', carDiagram);
                
                if (carDiagram) {
                    try {
                        const img = carDiagram.querySelector('img');
                        console.log('   img elemento:', img);
                        console.log('   img.complete:', img?.complete);
                        console.log('   img.src:', img?.src?.substring(0, 50) + '...');
                        
                        // Criar canvas manualmente (mais confiÃ¡vel que html2canvas)
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        console.log('   Canvas criado:', canvas);
                        
                        // Esperar imagem carregar se necessÃ¡rio
                        if (img && !img.complete) {
                            console.log('   â³ Aguardando imagem carregar...');
                            await new Promise((resolve, reject) => {
                                img.onload = () => {
                                    console.log('   âœ… Imagem carregada!');
                                    resolve();
                                };
                                img.onerror = () => {
                                    console.error('   âŒ Erro ao carregar imagem!');
                                    reject(new Error('Failed to load car diagram image'));
                                };
                                setTimeout(() => {
                                    console.error('   âŒ Timeout ao carregar imagem!');
                                    reject(new Error('Timeout loading image'));
                                }, 5000);
                            });
                        }
                        
                        if (!img || !img.complete) {
                            console.error('   âŒ Imagem nÃ£o estÃ¡ carregada!');
                            throw new Error('Car diagram image not loaded');
                        }
                        
                        console.log('   âœ… Imagem pronta para desenhar');
                        
                        // Definir tamanho do canvas baseado na imagem
                        canvas.width = img.naturalWidth || img.width || 1000;
                        canvas.height = img.naturalHeight || img.height || 700;
                        
                        // NÃƒO desenhar fundo branco - manter transparente para o PDF
                        // O canvas jÃ¡ Ã© transparente por padrÃ£o
                        
                        // Desenhar imagem do carro
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Carregar imagem do pin
                        const pinImg = new Image();
                        pinImg.src = '/static/pin.png';
                        
                        // Aguardar pin carregar
                        await new Promise((resolve) => {
                            if (pinImg.complete) {
                                resolve();
                            } else {
                                pinImg.onload = resolve;
                                pinImg.onerror = () => {
                                    console.error('Failed to load pin image');
                                    resolve(); // Continue anyway
                                };
                            }
                        });
                        
                        // Desenhar pins de danos
                        const pins = carDiagram.querySelectorAll('.damage-pin');
                        pins.forEach(pin => {
                            const rect = pin.getBoundingClientRect();
                            const containerRect = carDiagram.getBoundingClientRect();
                            
                            // Calcular posiÃ§Ã£o relativa ao canvas
                            const relX = (rect.left - containerRect.left) / containerRect.width;
                            const relY = (rect.top - containerRect.top) / containerRect.height;
                            
                            // PosiÃ§Ã£o no canvas
                            const canvasX = relX * canvas.width;
                            const canvasY = relY * canvas.height;
                            
                            // Tamanho do pin (proporcional ao canvas)
                            const pinWidth = 40 * (canvas.width / containerRect.width) * currentPinSize;
                            const pinHeight = 56 * (canvas.height / containerRect.height) * currentPinSize;
                            
                            // Desenhar imagem do pin (location icon)
                            // Centralizado horizontalmente, ancorado na parte inferior
                            ctx.drawImage(
                                pinImg,
                                canvasX - pinWidth / 2,
                                canvasY - pinHeight,
                                pinWidth,
                                pinHeight
                            );
                            
                            // Desenhar nÃºmero dentro do pin
                            const number = pin.textContent;
                            ctx.fillStyle = '#000000'; // PRETO (nÃ£o vermelho!)
                            ctx.font = `900 ${24 * currentPinSize}px Arial`; // MAIOR: 24px (era 20px)
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            // âœ… NÃºmero mais BAIXO na bola (ajustado para 0.35 - desceu mais)
                            // Valor menor = nÃºmero mais para BAIXO (menos subtraÃ§Ã£o do Y)
                            ctx.fillText(number, canvasX, canvasY - pinHeight * 0.35);
                        });
                        
                        const diagramBase64 = canvas.toDataURL('image/png', 0.95);
                        console.log('   ðŸ“¸ Canvas convertido para Base64');
                        console.log('   Base64 length:', diagramBase64.length);
                        console.log('   Base64 preview:', diagramBase64.substring(0, 100) + '...');
                        
                        // Validar
                        if (!diagramBase64 || diagramBase64 === 'data:,' || diagramBase64.length < 100) {
                            console.error('   âŒ Canvas vazio ou invÃ¡lido!');
                            console.error('   diagramBase64:', diagramBase64);
                            throw new Error('Empty canvas generated');
                        }
                        
                        data.vehicleDiagram = diagramBase64;
                        console.log('   âœ… data.vehicleDiagram DEFINIDO!');
                        console.log('   Pins desenhados:', pins.length);
                        console.log('   Size total:', diagramBase64.length, 'chars');
                        console.log('ðŸš— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        
                    } catch (error) {
                        console.error('ðŸš— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        console.error('âŒ ERRO AO CAPTURAR DIAGRAMA:', error);
                        console.error('   Mensagem:', error.message);
                        console.error('   Stack:', error.stack);
                        console.error('ðŸš— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        showNotification('Aviso: NÃ£o foi possÃ­vel capturar o diagrama - ' + error.message, 'warning');
                    }
                } else {
                    console.error('ðŸš— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.error('âŒ carDiagram elemento NÃƒO ENCONTRADO!');
                    console.error('   Procurado: #carDiagram');
                    console.error('ðŸš— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                }
                
                // Adicionar descriÃ§Ãµes de danos individuais
                damages.forEach((damage, index) => {
                    data[`damage_${index + 1}`] = damage.description || '';
                });
                
                // Adicionar itens de reparo (tabela de reparaÃ§Ãµes)
                data.repairItems = repairItems;
                console.log('âœ… Repair items:', repairItems);
                
                // Calcular e adicionar total de reparaÃ§Ã£o
                const totalRepairCost = repairItems.reduce((sum, item) => sum + item.total, 0);
                data.totalRepairCost = totalRepairCost.toFixed(2);
                console.log('âœ… Total repair cost:', data.totalRepairCost, 'â‚¬');
                
                // Adicionar imagens de danos (apenas base64 data, nÃ£o o objeto completo)
                damageImages.forEach((img, index) => {
                    data[`damagePhoto${index + 1}`] = img.data;  // âœ… Enviar apenas base64
                });
                console.log('âœ… Damage photos:', damageImages.length);
                
                // ðŸ”¥ GARANTIA FINAL: Adicionar campos essenciais que podem faltar
                // (Executado mesmo se cÃ³digo V2.0 nÃ£o carregar por cache)
                if (!data.drNumber && currentDRNumber) {
                    data.drNumber = currentDRNumber;
                    console.log('ðŸ”¥ FALLBACK: DR Number adicionado:', currentDRNumber);
                }
                
                const dateInput = document.getElementById('date');
                if (dateInput && dateInput.value && !data.date) {
                    data.date = dateInput.value;
                    console.log('ðŸ”¥ FALLBACK: Date adicionado:', dateInput.value);
                }
                
                if (damages && damages.length > 0 && !data.damageDiagramData) {
                    data.damageDiagramData = JSON.stringify(damages);
                    console.log('ðŸ”¥ FALLBACK: Damage pins adicionado:', damages.length, 'pins');
                }
                
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ðŸ“¤ðŸ“¤ðŸ“¤ DATA FINAL ANTES DE ENVIAR:');
                console.log('   drNumber:', data.drNumber);
                console.log('   contractNumber:', data.contractNumber);
                console.log('   date:', data.date);
                console.log('   vehicleDiagram:', data.vehicleDiagram ? `PRESENTE (${data.vehicleDiagram.length} chars)` : 'âŒ AUSENTE âŒ');
                console.log('   damageDiagramData (pins):', data.damageDiagramData ? `PRESENTE (${JSON.parse(data.damageDiagramData).length} pins)` : 'âŒ AUSENTE âŒ');
                console.log('   Total de campos:', Object.keys(data).length);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                
                preview.innerHTML = '<p style="text-align: center; color: #009cb6; padding: 60px; font-size: 15px;">â³ Gerando preview do PDF...</p>';
                
                // Enviar dados para gerar PDF preview
                const response = await fetch('/api/damage-reports/preview-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao gerar preview');
                }
                
                // Criar blob URL para o PDF
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                // Mostrar PDF no iframe
                preview.innerHTML = `
                    <iframe src="${url}" 
                            style="width: 100%; height: 900px; border: none; display: block;"
                            type="application/pdf">
                    </iframe>
                `;
                
                showNotification('Preview atualizado com sucesso!', 'success');
            } catch (error) {
                console.error('Error updating PDF preview:', error);
                showNotification('Erro ao gerar preview do PDF', 'error');
                document.getElementById('livePreview').innerHTML = `
                    <p style="text-align: center; color: #ef4444; padding: 60px 20px; font-size: 15px;">
                        âŒ Erro ao gerar preview. Preencha todos os campos obrigatÃ³rios.
                    </p>
                `;
            }
        }
        
        // Atualizar preview em tempo real (formato do PDF real)
        function updateLivePreview() {
            const formData = new FormData(document.getElementById('damageReportForm'));
            const data = Object.fromEntries(formData);
            
            const preview = document.getElementById('livePreview');
            preview.innerHTML = `
                <div style="max-width: 900px; margin: 0 auto; background: white; padding: 40px; box-shadow: 0 0 20px rgba(0,0,0,0.1);">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #009cb6; padding-bottom: 20px;">
                        <h1 style="color: #009cb6; margin: 0 0 10px 0; font-size: 32px; font-weight: bold;">DAMAGE REPORT</h1>
                        <p style="margin: 0; color: #6b7280; font-size: 14px;">AUTO PRUDENTE - Rent a Car</p>
                    </div>
                    
                    <!-- Contract Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <div>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: #6b7280; font-weight: 600;">CONTRATO NÂº</p>
                            <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1f2937;">${data.contractNumber || 'N/A'}</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: #6b7280; font-weight: 600;">DATA</p>
                            <p style="margin: 0; font-size: 16px; font-weight: bold; color: #1f2937;">${data.date || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <!-- Client Details -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #009cb6; font-size: 16px; font-weight: bold; border-bottom: 2px solid #009cb6; padding-bottom: 8px;">DADOS DO CLIENTE / CLIENT DETAILS</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">NOME / NAME</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937;">${data.clientName || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">EMAIL</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937;">${data.clientEmail || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">TELEFONE / PHONE</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937;">${data.clientPhone || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">MORADA / ADDRESS</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937;">${data.address || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">CIDADE / CITY</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937;">${data.city || 'N/A'} - ${data.postalCode || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">PAÃS / COUNTRY</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937;">${data.country || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vehicle Details -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #009cb6; font-size: 16px; font-weight: bold; border-bottom: 2px solid #009cb6; padding-bottom: 8px;">DADOS DO VEÃCULO / VEHICLE DETAILS</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">MATRÃCULA / PLATE</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937; font-weight: bold;">${data.vehiclePlate || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">MODELO / MODEL</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937;">${data.vehicleModel || 'N/A'}</p>
                            </div>
                            ${data.vehicleBrand ? `
                            <div>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280; font-weight: 600;">MARCA / BRAND</p>
                                <p style="margin: 0; font-size: 13px; color: #1f2937;">${data.vehicleBrand}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Rental Dates -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #009cb6; font-size: 16px; font-weight: bold; border-bottom: 2px solid #009cb6; padding-bottom: 8px;">ENTREGA E DEVOLUÃ‡ÃƒO / PICKUP & RETURN</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #009cb6; font-weight: bold;">ENTREGA / PICKUP</p>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280;">Data / Date: <strong>${data.pickupDate || 'N/A'}</strong></p>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280;">Hora / Time: <strong>${data.pickupTime || 'N/A'}</strong></p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">Local / Place: <strong>${data.pickupLocation || 'N/A'}</strong></p>
                            </div>
                            <div>
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #009cb6; font-weight: bold;">DEVOLUÃ‡ÃƒO / RETURN</p>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280;">Data / Date: <strong>${data.returnDate || 'N/A'}</strong></p>
                                <p style="margin: 0 0 3px 0; font-size: 11px; color: #6b7280;">Hora / Time: <strong>${data.returnTime || 'N/A'}</strong></p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">Local / Place: <strong>${data.returnLocation || 'N/A'}</strong></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Damages -->
                    ${damages.length > 0 ? `
                    <div style="margin-bottom: 25px; padding: 15px; border: 2px solid #ef4444; border-radius: 8px; background: #fef2f2;">
                        <h3 style="margin: 0 0 15px 0; color: #ef4444; font-size: 16px; font-weight: bold; border-bottom: 2px solid #ef4444; padding-bottom: 8px;">âš ï¸ DANOS NA VIATURA / VEHICLE DAMAGE (${damages.length})</h3>
                        ${damages.sort((a, b) => a.number - b.number).map(d => `
                            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px; padding: 8px; background: white; border-radius: 6px;">
                                <div style="width: 28px; height: 28px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0;">${d.number}</div>
                                <p style="margin: 0; font-size: 13px; color: #1f2937; line-height: 1.6;"><strong>${d.number}.</strong> ${d.description || 'Sem descriÃ§Ã£o'}</p>
                            </div>
                        `).join('')}
                    </div>
                    ` : '<div style="text-align: center; padding: 30px; background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; margin-bottom: 25px;"><p style="margin: 0; color: #10b981; font-size: 15px; font-weight: 600;">âœ“ Sem danos reportados / No damages reported</p></div>'}
                    
                    <!-- Repair Details -->
                    ${repairItems.length > 0 ? `
                    <div style="margin-bottom: 25px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #009cb6; font-size: 16px; font-weight: bold; border-bottom: 2px solid #009cb6; padding-bottom: 8px;">DETALHES DE REPARAÃ‡ÃƒO / REPAIR DETAILS</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb; font-size: 11px; color: #6b7280;">DETALHES DE REPARAÃ‡ÃƒO</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; width: 80px;">QUANTIDADES</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; width: 80px;">HORAS</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; width: 100px;">PREÃ‡O</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; width: 100px;">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${repairItems.map(item => `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #e5e7eb; font-size: 12px;">${item.description}</td>
                                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${item.quantity}</td>
                                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${item.hours === 0 ? '-' : item.hours + 'h'}</td>
                                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-size: 12px;">${item.price.toFixed(2)} â‚¬</td>
                                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-size: 12px; font-weight: bold;">${item.total.toFixed(2)} â‚¬</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="background: #f9fafb;">
                                    <td colspan="4" style="padding: 12px; border: 1px solid #e5e7eb; text-align: right; font-size: 14px; font-weight: bold; color: #1f2937;">TOTAL:</td>
                                    <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right; font-size: 16px; font-weight: bold; color: #009cb6;">${repairItems.reduce((sum, item) => sum + item.total, 0).toFixed(2)} â‚¬</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    ` : ''}
                    
                    <!-- Damage Photos -->
                    ${damageImages.length > 0 ? `
                    <div style="margin-bottom: 25px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #009cb6; font-size: 16px; font-weight: bold; border-bottom: 2px solid #009cb6; padding-bottom: 8px;">ðŸ“¸ FOTOS DOS DANOS / DAMAGE PHOTOS (${damageImages.length})</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            ${damageImages.map((img, idx) => `
                                <div style="border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                                    <img src="${img.data}" style="width: 100%; height: 200px; object-fit: cover; display: block;" alt="Damage Photo ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23f3f4f6%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2216%22 text-anchor=%22middle%22 fill=%22%236b7280%22%3EErro ao carregar%3C/text%3E%3C/svg%3E'">
                                    <p style="margin: 0; padding: 8px; background: #f9fafb; font-size: 11px; color: #6b7280; text-align: center;">Foto ${idx + 1}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Footer -->
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center;">
                        <p style="margin: 0; font-size: 11px; color: #6b7280;">AUTO PRUDENTE - Rent a Car | www.autoprudente.com</p>
                    </div>
                </div>
            `;
        }
        
        // Carregar histÃ³rico ao iniciar
        window.addEventListener('load', () => {
            loadHistory();
        });

        // Carregar histÃ³rico de DRs
        async function loadHistory() {
            try {
                const response = await fetch('/api/damage-reports/list');
                const data = await response.json();
                
                const historyList = document.getElementById('historyList');
                
                if (data.ok && data.reports && data.reports.length > 0) {
                    console.log('Total de reports:', data.reports.length);
                    
                    // Agrupar por ano
                    const reportsByYear = {};
                    data.reports.forEach(report => {
                        console.log('DR:', report.dr_number, 'is_protected:', report.is_protected);
                        
                        // Detectar ano com / ou :
                        const match = report.dr_number.match(/[\/:](\d{4})/);
                        const year = match ? match[1] : 'Outros';
                        
                        console.log('  -> Ano detectado:', year);
                        
                        if (!reportsByYear[year]) {
                            reportsByYear[year] = [];
                        }
                        reportsByYear[year].push(report);
                    });
                    
                    console.log('Reports por ano:', reportsByYear);
                    
                    // Ordenar anos (mais recente primeiro)
                    const years = Object.keys(reportsByYear).sort((a, b) => {
                        if (a === 'Outros') return 1;
                        if (b === 'Outros') return -1;
                        return parseInt(b) - parseInt(a);
                    });
                    
                    let html = '';
                    
                    years.forEach(year => {
                        // CabeÃ§alho do ano
                        html += `
                            <div style="background: linear-gradient(135deg, #009cb6 0%, #007a8c 100%); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; margin-top: ${year !== years[0] ? '25px' : '0'}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        ${year}
                                    </h3>
                                    <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 500;">
                                        ${reportsByYear[year].length} relatÃ³rio${reportsByYear[year].length > 1 ? 's' : ''}
                                    </span>
                                </div>
                            </div>
                        `;
                        
                        // Lista simples de relatÃ³rios do ano
                        reportsByYear[year].forEach(report => {
                            // DEBUG
                            console.log(`DR ${report.dr_number}: is_protected =`, report.is_protected, typeof report.is_protected);
                            
                            const protectedIcon = report.is_protected ? `
                                <svg style="width: 16px; height: 16px; color: #f59e0b; margin-left: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Protegido">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                            ` : '';
                            
                            html += `
                                <div style="background: white; margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 4px solid #009cb6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" 
                                     onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" 
                                     onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <svg style="width: 18px; height: 18px; color: #009cb6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                                </svg>
                                                <h4 style="margin: 0; color: #009cb6; font-size: 15px; font-weight: 600;">
                                                    ${report.dr_number}
                                                </h4>
                                                ${protectedIcon}
                                            </div>
                                            <p style="margin: 5px 0 0 26px; color: #6b7280; font-size: 13px;">
                                                ${report.client_name || 'A preencher'} â€¢ ${report.vehicle_plate || 'A preencher'}
                                            </p>
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            ${(report.is_protected === 1 || report.is_protected === true) ? `
                                                <!-- DR Protegido (upload) - Apenas Ver/Download (Ã­cones) -->
                                                <button onclick="viewProtectedPDF('${report.dr_number}', ${report.has_pdf})" style="background: transparent; color: #009cb6; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='transparent'" title="Ver PDF">
                                                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="downloadProtectedPDF('${report.dr_number}', ${report.has_pdf})" style="background: transparent; color: #009cb6; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='transparent'" title="Download PDF">
                                                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                    </svg>
                                                </button>
                                            ` : `
                                                <!-- DR Manual - Editar e Eliminar -->
                                                ${report.dr_number.includes(':') ? `
                                                    <!-- DR com formato invÃ¡lido - Apenas eliminar -->
                                                    <span style="color: #f59e0b; font-size: 12px; padding: 8px;">âš ï¸ Formato invÃ¡lido</span>
                                                    <button onclick="deleteDR('${report.dr_number}')" style="background: transparent; color: #ef4444; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='transparent'" title="Eliminar DR">
                                                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                        </svg>
                                                    </button>
                                                ` : `
                                                    <!-- DR vÃ¡lido - Preview, Download, Email, e se nÃ£o protegido: Editar/Eliminar -->
                                                    <button onclick="window.open('/api/damage-reports/${encodeURIComponent(report.dr_number)}/pdf?preview=true', '_blank')" style="background: transparent; color: #009cb6; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='transparent'" title="Ver PDF">
                                                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                        </svg>
                                                    </button>
                                                    <button onclick="window.open('/api/damage-reports/${encodeURIComponent(report.dr_number)}/pdf', '_blank')" style="background: transparent; color: #009cb6; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='transparent'" title="Download PDF">
                                                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                    </button>
                                                    <button onclick="openEmailModal('${report.dr_number}', '${(report.client_email || '').replace(/'/g, "\\'")}', '${(report.client_name || '').replace(/'/g, "\\'")}', '${(report.country || 'PT').replace(/'/g, "\\'")}');" style="background: transparent; color: #009cb6; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='transparent'" title="Enviar Email">
                                                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                                        </svg>
                                                    </button>
                                                    ${report.is_protected ? '' : `
                                                        <button onclick="editDR('${report.dr_number}')" style="background: transparent; color: #009cb6; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='transparent'" title="Editar DR">
                                                            <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                            </svg>
                                                        </button>
                                                        <button onclick="deleteDR('${report.dr_number}')" style="background: transparent; color: #ef4444; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='transparent'" title="Eliminar DR">
                                                            <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                            </svg>
                                                        </button>
                                                    `}
                                                `}
                                            `}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    });
                    
                    historyList.innerHTML = html;
                } else {
                    historyList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <svg style="width: 48px; height: 48px; margin: 0 auto 15px; color: #d1d5db;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p style="font-size: 15px; margin: 0;">Nenhum Damage Report criado ainda</p>
                            <p style="font-size: 13px; margin: 8px 0 0 0;">Preencha o formulÃ¡rio para criar o primeiro</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar histÃ³rico:', error);
                document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: white; padding: 30px; opacity: 0.8;">âŒ Erro ao carregar histÃ³rico</p>';
            }
        }
        
        // Carregar DR para preview (sem editar)
        async function loadDRForPreview(drNumber) {
            currentDRNumber = drNumber;
            previewDR();
        }

        // Carregar DR especÃ­fico
        async function loadDR(drNumber) {
            try {
                const response = await fetch(`/api/damage-reports/${drNumber}`);
                const data = await response.json();
                
                if (data.ok && data.report) {
                    const r = data.report;
                    currentDRNumber = drNumber;
                    
                    // Preencher formulÃ¡rio
                    if (r.contract_number) document.getElementById('contractNumber').value = r.contract_number;
                    if (r.date) document.getElementById('date').value = r.date;
                    if (r.client_name) document.getElementById('clientName').value = r.client_name;
                    if (r.client_email) document.getElementById('clientEmail').value = r.client_email;
                    if (r.client_phone) document.getElementById('clientPhone').value = r.client_phone;
                    if (r.client_address) document.getElementById('address').value = r.client_address;
                    // Combinar cÃ³digo postal e cidade
                    if (r.client_postal_code || r.client_city) {
                        const postalCodeCity = [r.client_postal_code, r.client_city].filter(x => x).join(' / ');
                        document.getElementById('postalCodeCity').value = postalCodeCity;
                    }
                    if (r.vehicle_plate) document.getElementById('vehiclePlate').value = r.vehicle_plate;
                    // Combinar marca e modelo
                    if (r.vehicle_brand || r.vehicle_model) {
                        const brandModel = [r.vehicle_brand, r.vehicle_model].filter(x => x).join(' / ');
                        document.getElementById('vehicleBrandModel').value = brandModel;
                    }
                    if (r.pickup_date) document.getElementById('pickupDate').value = r.pickup_date.split('T')[0];
                    if (r.return_date) document.getElementById('returnDate').value = r.return_date.split('T')[0];
                    if (r.pickup_location) document.getElementById('pickupLocation').value = r.pickup_location;
                    if (r.return_location) document.getElementById('returnLocation').value = r.return_location;
                    if (r.damage_description) document.getElementById('damageDescription').value = r.damage_description;
                    
                    // Mostrar botÃµes
                    const downloadBtn = document.getElementById('downloadBtn');
                    const downloadBtnHeader = document.getElementById('downloadBtnHeader');
                    const previewBtn = document.getElementById('previewBtn');
                    
                    if (downloadBtn) downloadBtn.style.display = 'inline-flex';
                    if (downloadBtnHeader) downloadBtnHeader.style.display = 'inline-flex';
                    if (previewBtn) previewBtn.style.display = 'inline-flex';
                    
                    // Scroll para o formulÃ¡rio
                    document.getElementById('damageReportForm').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Erro ao carregar DR:', error);
                showNotification('Erro ao carregar Damage Report', 'error');
            }
        }

        // Testar preview com logs
        async function testPDFPreview(drNumber) {
            console.log('=== TESTE PREVIEW ===');
            console.log('DR Number:', drNumber);
            
            const url = `/api/damage-reports/${encodeURIComponent(drNumber)}/pdf-original?preview=true`;
            console.log('URL:', url);
            
            try {
                const response = await fetch(url);
                console.log('Status:', response.status);
                console.log('Content-Type:', response.headers.get('content-type'));
                
                if (response.ok) {
                    // Abrir em nova janela
                    window.open(url, '_blank');
                } else {
                    const errorText = await response.text();
                    console.error('Erro:', errorText);
                    alert('Erro ao abrir PDF: ' + errorText);
                }
            } catch (error) {
                console.error('Erro na requisiÃ§Ã£o:', error);
                alert('Erro: ' + error.message);
            }
        }
        
        // Testar download com logs
        async function testPDFDownload(drNumber) {
            console.log('=== TESTE DOWNLOAD ===');
            console.log('DR Number:', drNumber);
            
            const url = `/api/damage-reports/${encodeURIComponent(drNumber)}/pdf-original`;
            console.log('URL:', url);
            
            try {
                const response = await fetch(url);
                console.log('Status:', response.status);
                console.log('Content-Type:', response.headers.get('content-type'));
                
                if (response.ok) {
                    // Abrir em nova janela para download
                    window.open(url, '_blank');
                } else {
                    const errorText = await response.text();
                    console.error('Erro:', errorText);
                    alert('Erro ao fazer download: ' + errorText);
                }
            } catch (error) {
                console.error('Erro na requisiÃ§Ã£o:', error);
                alert('Erro: ' + error.message);
            }
        }
        
        // Editar DR - Carrega dados e muda para tab Criar
        async function editDR(drNumber) {
            try {
                const response = await fetch(`/api/damage-reports/${encodeURIComponent(drNumber)}`);
                
                if (!response.ok) {
                    showNotification(`Erro ao carregar DR: ${response.status} ${response.statusText}`, 'error');
                    return;
                }
                
                const result = await response.json();
                
                if (result.ok && result.report) {
                    const report = result.report;
                    
                    // Preencher formulÃ¡rio
                    document.getElementById('contractNumber').value = report.contract_number || '';
                    document.getElementById('date').value = report.date || '';
                    document.getElementById('clientName').value = report.client_name || '';
                    document.getElementById('clientEmail').value = report.client_email || '';
                    document.getElementById('clientPhone').value = report.client_phone || '';
                    document.getElementById('address').value = report.client_address || '';
                    // Combinar cÃ³digo postal e cidade
                    const postalCodeCity = [report.client_postal_code, report.client_city].filter(x => x).join(' / ');
                    document.getElementById('postalCodeCity').value = postalCodeCity;
                    document.getElementById('country').value = report.client_country || '';
                    document.getElementById('vehiclePlate').value = report.vehicle_plate || '';
                    // Combinar marca e modelo
                    const brandModel = [report.vehicle_brand, report.vehicle_model].filter(x => x).join(' / ');
                    document.getElementById('vehicleBrandModel').value = brandModel;
                    document.getElementById('pickupDate').value = report.pickup_date || '';
                    document.getElementById('pickupTime').value = report.pickup_time || '';
                    document.getElementById('pickupLocation').value = report.pickup_location || '';
                    document.getElementById('returnDate').value = report.return_date || '';
                    document.getElementById('returnTime').value = report.return_time || '';
                    document.getElementById('returnLocation').value = report.return_location || '';
                    
                    // Carregar danos se existirem
                    if (report.damage_diagram_data) {
                        try {
                            damages = JSON.parse(report.damage_diagram_data);
                            damageCounter = Math.max(...damages.map(d => d.number), 0);
                            // Recriar pins
                            damages.forEach(d => {
                                const container = document.querySelector(`[data-view="${d.view}"]`);
                                if (container) {
                                    const pin = document.createElement('div');
                                    pin.className = 'damage-pin';
                                    pin.id = d.id;
                                    pin.textContent = d.number;
                                    pin.style.left = d.x + 'px';
                                    pin.style.top = d.y + 'px';
                                    // Aplicar tamanho salvo (default 1.0 se nÃ£o existir)
                                    const pinSize = d.size || 1.0;
                                    pin.style.transform = `translate(-50%, -100%) scale(${pinSize})`;
                                    pin.onclick = (e) => {
                                        e.stopPropagation();
                                        removeDamagePin(d.id);
                                    };
                                    container.appendChild(pin);
                                }
                            });
                            updateDamageList();
                        } catch (e) {
                            console.error('Erro ao carregar danos:', e);
                        }
                    }
                    
                    // Carregar itens de reparo
                    if (report.repair_items) {
                        try {
                            repairItems = JSON.parse(report.repair_items);
                            updateRepairTable();
                        } catch (e) {
                            console.error('Erro ao carregar reparos:', e);
                        }
                    }
                    
                    // Guardar DR number atual para update
                    currentDRNumber = drNumber;
                    
                    // Mudar estilo do botÃ£o para modo "Atualizar DR"
                    const submitBtn = document.getElementById('submitButton');
                    submitBtn.title = 'Atualizar DR';
                    submitBtn.style.background = '#f59e0b';
                    submitBtn.style.borderColor = '#f59e0b';
                    submitBtn.style.color = 'white';
                    
                    // Mudar para tab Criar
                    document.querySelector('[onclick="showTab(\'create\')"]').click();
                    
                    // Scroll para o topo
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    showNotification(`A editar DR ${drNumber}`, 'success');
                } else {
                    showNotification('Erro ao carregar DR', 'error');
                }
            } catch (error) {
                console.error('Erro ao editar:', error);
                showNotification('Erro ao carregar DR para ediÃ§Ã£o', 'error');
            }
        }
        
        // Eliminar DR
        async function deleteDR(drNumber) {
            if (!confirm(`Tem a certeza que deseja eliminar o DR ${drNumber}?\n\nEsta aÃ§Ã£o nÃ£o pode ser revertida.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/damage-reports/${encodeURIComponent(drNumber)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Este DR estÃ¡ protegido e nÃ£o pode ser eliminado', 'error');
                    } else if (response.status === 404) {
                        showNotification(`DR ${drNumber} nÃ£o encontrado`, 'error');
                    } else {
                        showNotification(`Erro ao eliminar DR: ${response.status}`, 'error');
                    }
                    return;
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    showNotification(`DR ${drNumber} eliminado com sucesso`, 'success');
                    loadHistory();
                } else {
                    showNotification('Erro ao eliminar DR: ' + (result.error || 'Desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro ao eliminar:', error);
                showNotification('Erro ao eliminar DR: ' + error.message, 'error');
            }
        }
        
        // Ver PDF de DR protegido
        function viewProtectedPDF(drNumber, hasPdf) {
            // Usar endpoint separado com query parameter
            const endpoint = hasPdf 
                ? `/api/damage-reports-pdf?dr_number=${encodeURIComponent(drNumber)}&preview=true`
                : `/api/damage-reports/${encodeURIComponent(drNumber)}/pdf?preview=true`;
            window.open(endpoint, '_blank');
        }
        
        // Download PDF de DR protegido
        function downloadProtectedPDF(drNumber, hasPdf) {
            // Usar endpoint separado com query parameter
            const endpoint = hasPdf 
                ? `/api/damage-reports-pdf?dr_number=${encodeURIComponent(drNumber)}`
                : `/api/damage-reports/${encodeURIComponent(drNumber)}/pdf`;
            window.open(endpoint, '_blank');
        }
        
        // Download PDF do DR (gerado com template mapeado)
        async function downloadDRPDF(drNumber) {
            window.open(`/api/damage-reports/${encodeURIComponent(drNumber)}/pdf`, '_blank');
        }

        function downloadPDF() {
            if (currentDRNumber) {
                downloadDRPDF(currentDRNumber);
            }
        }

        // Upload RA
        async function handleRAUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Mostrar nome do ficheiro
            const filenameSpan = document.getElementById('raFilename');
            filenameSpan.textContent = `ðŸ“Ž ${file.name}`;
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Mostrar loading
            const uploadBtn = event.target.parentElement.querySelector('button');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<span style="display: flex; align-items: center; gap: 8px;"><svg class="icon-mono" style="animation: spin 1s linear infinite;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>Extraindo...</span>';
            uploadBtn.disabled = true;
            
            try {
                const response = await fetch('/api/damage-reports/extract-from-ra', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.ok && data.fields) {
                    const fields = data.fields;
                    // Preencher Contract Number se extraÃ­do
                    if (fields.contractNumber) document.getElementById('contractNumber').value = fields.contractNumber.toUpperCase();
                    
                    if (fields.clientName) document.getElementById('clientName').value = fields.clientName.toUpperCase();
                    if (fields.clientEmail) document.getElementById('clientEmail').value = fields.clientEmail.toLowerCase();
                    if (fields.clientPhone) document.getElementById('clientPhone').value = fields.clientPhone;
                    if (fields.vehiclePlate) document.getElementById('vehiclePlate').value = fields.vehiclePlate.toUpperCase();
                    // Marca / Modelo - Usar campo combinado do backend ou combinar manualmente
                    if (fields.vehicleBrandModel) {
                        document.getElementById('vehicleBrandModel').value = fields.vehicleBrandModel.toUpperCase();
                    } else if (fields.vehicleBrand || fields.vehicleModel) {
                        const brandModel = [fields.vehicleBrand, fields.vehicleModel].filter(x => x).map(x => x.toUpperCase()).join(' / ');
                        document.getElementById('vehicleBrandModel').value = brandModel;
                    }
                    if (fields.address) document.getElementById('address').value = fields.address.toUpperCase();
                    // CÃ³digo Postal / Cidade - Usar campo combinado do backend ou combinar manualmente
                    if (fields.postalCodeCity) {
                        document.getElementById('postalCodeCity').value = fields.postalCodeCity.toUpperCase();
                    } else if (fields.postalCode || fields.city) {
                        const postalCodeCity = [fields.postalCode, fields.city?.toUpperCase()].filter(x => x).join(' / ');
                        document.getElementById('postalCodeCity').value = postalCodeCity;
                    }
                    if (fields.country) document.getElementById('country').value = fields.country.toUpperCase();
                    if (fields.pickupDate) {
                        // Remover espaÃ§os e converter "06 - 11 - 2025" â†’ "2025-11-06"
                        const dateClean = fields.pickupDate.replace(/\s+/g, ''); // Remove todos os espaÃ§os
                        const parts = dateClean.split('-');
                        if (parts.length === 3) {
                            document.getElementById('pickupDate').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                    }
                    if (fields.returnDate) {
                        // Remover espaÃ§os e converter "06 - 12 - 2025" â†’ "2025-12-06"
                        const dateClean = fields.returnDate.replace(/\s+/g, ''); // Remove todos os espaÃ§os
                        const parts = dateClean.split('-');
                        if (parts.length === 3) {
                            document.getElementById('returnDate').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                    }
                    if (fields.pickupTime) {
                        // Remover espaÃ§os: "10 : 30" â†’ "10:30"
                        document.getElementById('pickupTime').value = fields.pickupTime.replace(/\s+/g, '');
                    }
                    if (fields.returnTime) {
                        // Remover espaÃ§os: "12 : 00" â†’ "12:00"
                        document.getElementById('returnTime').value = fields.returnTime.replace(/\s+/g, '');
                    }
                    if (fields.pickupLocation) document.getElementById('pickupLocation').value = fields.pickupLocation.toUpperCase();
                    if (fields.returnLocation) document.getElementById('returnLocation').value = fields.returnLocation.toUpperCase();
                    
                    showNotification('Dados extraÃ­dos com sucesso do Rental Agreement!', 'success');
                    
                    // Scroll para o formulÃ¡rio
                    document.getElementById('damageReportForm').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showNotification('Erro ao extrair dados: ' + (data.error || 'Desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao fazer upload', 'error');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
                event.target.value = '';
            }
        }

        // Preview do DR
        function previewDR() {
            if (!currentDRNumber) {
                showNotification('Guarde o Damage Report primeiro para poder visualizÃ¡-lo', 'warning');
                return;
            }
            
            // Abrir PDF gerado com template em nova janela
            window.open(`/api/damage-reports/${encodeURIComponent(currentDRNumber)}/pdf?preview=true`, '_blank');
        }

        // Adicionar pin de dano
        function addDamagePin(event, view) {
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // âœ… CONVERTER para coordenadas do CANVAS (986x700)
            // O container pode estar renderizado com tamanho diferente do canvas!
            const img = container.querySelector('img');
            const canvasWidth = img.naturalWidth || 986;
            const canvasHeight = img.naturalHeight || 700;
            
            // Coordenadas em proporÃ§Ã£o (0.0 a 1.0)
            const relX = x / rect.width;
            const relY = y / rect.height;
            
            // Coordenadas no canvas (usadas pelo backend)
            const canvasX = relX * canvasWidth;
            const canvasY = relY * canvasHeight;
            
            damageCounter++;
            const damageId = `damage-${view}-${damageCounter}`;
            
            console.log(`ðŸŽ¯ Adicionando pin #${damageCounter}`);
            console.log(`   Clique renderizado: (${Math.round(x)}, ${Math.round(y)})`);
            console.log(`   Container renderizado: ${Math.round(rect.width)}x${Math.round(rect.height)}`);
            console.log(`   âœ… Coordenadas canvas: (${Math.round(canvasX)}, ${Math.round(canvasY)}) [${canvasWidth}x${canvasHeight}]`);
            
            // Criar pin (usar coordenadas renderizadas para display)
            const pin = document.createElement('div');
            pin.className = 'damage-pin';
            pin.id = damageId;
            pin.textContent = damageCounter;
            pin.style.left = x + 'px';
            pin.style.top = y + 'px';
            pin.style.transform = `translate(-50%, -100%) scale(${currentPinSize})`;
            pin.onclick = (e) => {
                e.stopPropagation();
                removeDamagePin(damageId);
            };
            
            container.appendChild(pin);
            
            // âœ… Adicionar Ã  lista (usar coordenadas do CANVAS)
            damages.push({
                id: damageId,
                number: damageCounter,
                view: view,
                x: canvasX,  // â† Coordenadas do canvas!
                y: canvasY,  // â† Coordenadas do canvas!
                size: currentPinSize
            });
            
            updateDamageList();
        }

        // Remover pin
        function removeDamagePin(damageId) {
            const pin = document.getElementById(damageId);
            if (pin) pin.remove();
            
            // Remover do array
            damages = damages.filter(d => d.id !== damageId);
            
            // âœ… RENUMERAR todos os pins restantes
            damages.forEach((damage, index) => {
                damage.number = index + 1;  // Renumerar sequencialmente
                
                // Atualizar o nÃºmero visual no pin
                const pinElement = document.getElementById(damage.id);
                if (pinElement) {
                    pinElement.textContent = damage.number;  // Atualizar texto do pin
                }
            });
            
            // âœ… RESETAR CONTADOR para o prÃ³ximo nÃºmero disponÃ­vel
            damageCounter = damages.length;  // Se tinha 3 e removeu 1, fica com 2, prÃ³ximo serÃ¡ 3
            console.log(`âœ… Pin removido. Total pins: ${damages.length}, prÃ³ximo nÃºmero: ${damageCounter + 1}`);
            
            updateDamageList();
        }

        // Atualizar lista de danos
        function updateDamageList() {
            const list = document.getElementById('damageList');
            const items = document.getElementById('damageItems');
            
            if (damages.length === 0) {
                list.style.display = 'none';
                updateDamageDetails();
                return;
            }
            
            list.style.display = 'block';
            items.innerHTML = damages.map(d => `
                <div class="damage-item">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="damage-number">${d.number}</div>
                        <span><strong>Dano #${d.number}</strong></span>
                    </div>
                    <button type="button" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="removeDamagePin('${d.id}')">
                        Remover
                    </button>
                </div>
            `).join('');
            
            updateDamageDetails();
        }
        
        // Atualizar campos de descriÃ§Ã£o de danos
        function updateDamageDetails() {
            const container = document.getElementById('damageDetailsContainer');
            const detailsList = document.getElementById('damageDetailsList');
            const noMessage = document.getElementById('noDamagesMessage');
            
            if (damages.length === 0) {
                container.style.display = 'none';
                noMessage.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            noMessage.style.display = 'none';
            
            // Ordenar por nÃºmero
            const sortedDamages = [...damages].sort((a, b) => a.number - b.number);
            
            detailsList.innerHTML = sortedDamages.map(d => `
                <div class="damage-detail-row" id="detail-${d.id}">
                    <div class="damage-detail-number">${d.number}</div>
                    <div class="damage-detail-input">
                        <input 
                            type="text" 
                            id="damage-desc-${d.number}" 
                            name="damage-desc-${d.number}"
                            placeholder="${d.number}. DescriÃ§Ã£o do dano (Ex: Risco no para-choques dianteiro)"
                            value="${d.description ? (d.number + '. ' + d.description) : ''}"
                            onchange="updateDamageDescription(${d.number}, this.value.replace(/^\d+\.\s*/, ''))"
                        >
                    </div>
                    <div class="damage-detail-delete">
                        <button type="button" class="btn btn-secondary" style="padding: 10px 12px;" onclick="removeDamagePin('${d.id}')" title="Remover dano">
                            <svg class="icon-mono" style="width: 20px; height: 20px;" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Atualizar descriÃ§Ã£o de um dano
        function updateDamageDescription(damageNumber, description) {
            const damage = damages.find(d => d.number === damageNumber);
            if (damage) {
                damage.description = description;
            }
        }
        
        // Adicionar linha de reparo
        function addRepairRow() {
            const id = Date.now();
            // Default: quantidade=1, horas=- (0), preÃ§o=20
            // CÃ¡lculo correto: 1 Ã— 20 = 20 (sem horas)
            repairItems.push({ id, description: '', quantity: 1, hours: 0, price: 20, total: 20 });
            updateRepairTable();
        }
        
        // Remover linha de reparo
        function removeRepairRow(id) {
            repairItems = repairItems.filter(item => item.id !== id);
            updateRepairTable();
        }
        
        // Atualizar tabela de reparos
        function updateRepairTable() {
            const tbody = document.getElementById('repairTableBody');
            
            if (repairItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: #6b7280; border: 1px solid #e5e7eb;">
                            Clique no botÃ£o + para adicionar itens de reparaÃ§Ã£o
                        </td>
                    </tr>
                `;
                document.getElementById('repairTotal').textContent = '0.00 â‚¬';
                return;
            }
            
            tbody.innerHTML = repairItems.map(item => `
                <tr>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;">
                        <input type="text" 
                               value="${item.description}" 
                               onchange="updateRepairItem(${item.id}, 'description', this.value)"
                               placeholder="Ex: PINTURA PARA-LAMAS DIANTEIRO DIREITO"
                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; text-transform: uppercase;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">
                        <select onchange="updateRepairItem(${item.id}, 'quantity', parseInt(this.value))"
                                style="width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; text-align: center; font-size: 13px;">
                            <option value="1" ${item.quantity === 1 ? 'selected' : ''}>1</option>
                            <option value="2" ${item.quantity === 2 ? 'selected' : ''}>2</option>
                            <option value="3" ${item.quantity === 3 ? 'selected' : ''}>3</option>
                            <option value="4" ${item.quantity === 4 ? 'selected' : ''}>4</option>
                            <option value="5" ${item.quantity === 5 ? 'selected' : ''}>5</option>
                            <option value="6" ${item.quantity === 6 ? 'selected' : ''}>6</option>
                            <option value="7" ${item.quantity === 7 ? 'selected' : ''}>7</option>
                            <option value="8" ${item.quantity === 8 ? 'selected' : ''}>8</option>
                            <option value="9" ${item.quantity === 9 ? 'selected' : ''}>9</option>
                            <option value="10" ${item.quantity === 10 ? 'selected' : ''}>10</option>
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">
                        <select onchange="updateRepairItem(${item.id}, 'hours', this.value === '-' ? 0 : parseInt(this.value))"
                                style="width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; text-align: center; font-size: 13px;">
                            <option value="-" ${item.hours === '-' || item.hours === 0 ? 'selected' : ''}>-</option>
                            <option value="1" ${item.hours === 1 ? 'selected' : ''}>1h</option>
                            <option value="2" ${item.hours === 2 ? 'selected' : ''}>2h</option>
                            <option value="3" ${item.hours === 3 ? 'selected' : ''}>3h</option>
                            <option value="4" ${item.hours === 4 ? 'selected' : ''}>4h</option>
                            <option value="5" ${item.hours === 5 ? 'selected' : ''}>5h</option>
                            <option value="6" ${item.hours === 6 ? 'selected' : ''}>6h</option>
                            <option value="7" ${item.hours === 7 ? 'selected' : ''}>7h</option>
                            <option value="8" ${item.hours === 8 ? 'selected' : ''}>8h</option>
                            <option value="9" ${item.hours === 9 ? 'selected' : ''}>9h</option>
                            <option value="10" ${item.hours === 10 ? 'selected' : ''}>10h</option>
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">
                        <input type="number" 
                               value="${item.price}" 
                               onchange="updateRepairItem(${item.id}, 'price', parseFloat(this.value))"
                               min="0"
                               step="0.01"
                               placeholder="0.00"
                               style="width: 100px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; text-align: right; font-size: 13px;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #374151;">
                        ${item.total.toFixed(2)} â‚¬
                    </td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">
                        <button type="button" onclick="removeRepairRow(${item.id})" style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-weight: bold;">Ã—</button>
                    </td>
                </tr>
            `).join('');
            
            // Atualizar total
            const total = repairItems.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('repairTotal').textContent = total.toFixed(2) + ' â‚¬';
        }
        
        // Atualizar item de reparo
        function updateRepairItem(id, field, value) {
            const item = repairItems.find(i => i.id === id);
            if (item) {
                item[field] = value;
                
                // Calcular total
                // Se horas for "-" ou 0: Quantidade Ã— PreÃ§o (IGNORA horas)
                // Caso contrÃ¡rio: Quantidade Ã— Horas Ã— PreÃ§o (INCLUI horas)
                if (field === 'quantity' || field === 'hours' || field === 'price') {
                    if (item.hours === '-' || item.hours === 0) {
                        // SEM HORAS: apenas quantidade e preÃ§o
                        item.total = item.quantity * item.price;
                    } else {
                        // COM HORAS: quantidade Ã— horas Ã— preÃ§o
                        item.total = item.quantity * item.hours * item.price;
                    }
                }
                updateRepairTable();
            }
        }

        // Limpar formulÃ¡rio
        function clearForm() {
            if (confirm('Tem a certeza que deseja limpar todos os campos?')) {
                document.getElementById('damageReportForm').reset();
                damages = [];
                damageCounter = 0;
                repairItems = [];
                damageImages = [];
                currentDRNumber = null;
                document.querySelectorAll('.damage-pin').forEach(pin => pin.remove());
                updateDamageList();
                updateRepairTable();
                updateImageGallery();
                
                const downloadBtn = document.getElementById('downloadBtn');
                const downloadBtnHeader = document.getElementById('downloadBtnHeader');
                const previewBtn = document.getElementById('previewBtn');
                
                if (downloadBtn) downloadBtn.style.display = 'none';
                if (downloadBtnHeader) downloadBtnHeader.style.display = 'none';
                if (previewBtn) previewBtn.style.display = 'none';
                
                // Resetar botÃ£o para modo criar
                const submitBtn = document.getElementById('submitButton');
                submitBtn.title = 'Criar Damage Report com PDF';
                submitBtn.style.background = '#10b981';
                submitBtn.style.borderColor = '#10b981';
                submitBtn.style.color = 'white';
            }
        }

        // Submit
        document.getElementById('damageReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('ðŸ’¾ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ðŸ’¾ SUBMIT FORM - Criar Damage Report com PDF');
            console.log('   Event:', e);
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            console.log('   FormData convertido:', Object.keys(data).length, 'campos');
            
            // Adicionar dados dos danos
            data.damageDiagramData = JSON.stringify(damages);
            console.log('   Damages:', damages.length, 'pins');
            
            // Criar descriÃ§Ã£o completa dos danos
            const damageDescriptions = damages
                .sort((a, b) => a.number - b.number)
                .map(d => `${d.number}. ${d.description || 'Sem descriÃ§Ã£o'}`)
                .join('\n');
            
            data.damageDescription = damageDescriptions;
            console.log('   DescriÃ§Ã£o danos:', damageDescriptions.substring(0, 100) + '...');
            
            // âœ… ADICIONAR DESCRIÃ‡Ã•ES INDIVIDUAIS (damage_1, damage_2, ...)
            damages.forEach(damage => {
                data[`damage_${damage.number}`] = damage.description || '';
            });
            console.log('   DescriÃ§Ãµes individuais:', damages.length, 'campos (damage_1 a damage_' + damages.length + ')');
            
            // Adicionar itens de reparo
            data.repairItems = JSON.stringify(repairItems);
            const repairTotal = repairItems.reduce((sum, item) => sum + item.total, 0);
            data.repairTotal = repairTotal.toFixed(2);
            data.totalCost = repairTotal.toFixed(2);  // Para compatibilidade com BD
            data.totalRepairCost = repairTotal.toFixed(2);  // Para o PDF
            
            // âœ… ADICIONAR ITENS DE REPARAÃ‡ÃƒO INDIVIDUAIS (repair_line_1, repair_line_2, ...)
            repairItems.forEach((item, index) => {
                const lineNum = index + 1;
                data[`repair_line_${lineNum}`] = item.description || '';
                data[`repair_line_${lineNum}_qty`] = item.quantity || '';
                data[`repair_line_${lineNum}_hours`] = item.hours || '';
                data[`repair_line_${lineNum}_price`] = item.price || '';
                data[`repair_line_${lineNum}_subtotal`] = item.total || '';
            });
            console.log('   Itens reparaÃ§Ã£o individuais:', repairItems.length, 'linhas');
            
            // Adicionar imagens
            data.damageImages = JSON.stringify(damageImages);
            
            // âœ… ADICIONAR FOTOS INDIVIDUAIS (damagePhoto1, damagePhoto2, ...)
            damageImages.forEach((image, index) => {
                data[`damagePhoto${index + 1}`] = image.data || '';
            });
            console.log('   Fotos individuais:', damageImages.length, 'campos (damagePhoto1 a damagePhoto' + damageImages.length + ')');
            
            // âœ… GERAR CROQUI COM PINS DESENHADOS (vehicle_diagram)
            console.log('   ðŸš— Gerando croqui com pins...');
            try {
                const canvas = document.getElementById('carDiagram');
                if (canvas && damages.length > 0) {
                    const diagramBase64 = await html2canvas(canvas, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        logging: false
                    }).then(canvas => canvas.toDataURL('image/png'));
                    
                    data.vehicleDiagram = diagramBase64;
                    console.log('   âœ… Croqui gerado:', diagramBase64.length, 'chars');
                } else {
                    console.log('   âš ï¸ Sem pins - croqui nÃ£o gerado');
                }
            } catch (err) {
                console.error('   âŒ Erro ao gerar croqui:', err);
            }
            
            // Se estamos editando, enviar o DR number existente
            if (currentDRNumber) {
                data.existingDRNumber = currentDRNumber;
                console.log('   Modo: ATUALIZAR DR existente:', currentDRNumber);
            } else {
                console.log('   Modo: CRIAR novo DR');
            }
            
            try {
                console.log('   ðŸ“¤ Enviando para /api/damage-reports/create...');
                const response = await fetch('/api/damage-reports/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                console.log('   ðŸ“¥ Response status:', response.status);
                const result = await response.json();
                console.log('   ðŸ“¥ Result:', result);
                
                if (result.ok) {
                    currentDRNumber = result.dr_number;
                    console.log('   âœ… SUCCESS! DR Number:', result.dr_number);
                    
                    // Verificar se foi criaÃ§Ã£o ou atualizaÃ§Ã£o
                    const isUpdate = document.getElementById('submitButton').title.includes('Atualizar');
                    
                    if (!isUpdate) {
                        // NOVO DR - Gerar PDF automaticamente
                        console.log('   ðŸ”§ Gerando PDF automaticamente...');
                        showNotification(`DR ${result.dr_number} criado! Gerando PDF...`, 'info');
                        
                        try {
                            const pdfResponse = await fetch(`/api/damage-reports/${encodeURIComponent(result.dr_number)}/generate-and-save-pdf`, {
                                method: 'POST'
                            });
                            
                            const pdfResult = await pdfResponse.json();
                            
                            if (pdfResult.ok) {
                                console.log('   âœ… PDF gerado e salvo:', pdfResult.size, 'bytes');
                                showNotification(`DR ${result.dr_number} criado com PDF (${(pdfResult.size / 1024).toFixed(0)} KB)`, 'success');
                            } else {
                                console.error('   âŒ Erro ao gerar PDF:', pdfResult.error);
                                showNotification(`DR ${result.dr_number} criado mas erro no PDF: ${pdfResult.error}`, 'warning');
                            }
                        } catch (pdfError) {
                            console.error('   âŒ Exception ao gerar PDF:', pdfError);
                            showNotification(`DR ${result.dr_number} criado mas erro no PDF`, 'warning');
                        }
                    } else {
                        showNotification(`DR ${result.dr_number} atualizado`, 'success');
                    }
                    
                    console.log('ðŸ’¾ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    
                    // Mostrar botÃµes no header e no formulÃ¡rio
                    const downloadBtn = document.getElementById('downloadBtn');
                    const downloadBtnHeader = document.getElementById('downloadBtnHeader');
                    const previewBtn = document.getElementById('previewBtn');
                    
                    if (downloadBtn) downloadBtn.style.display = 'inline-flex';
                    if (downloadBtnHeader) downloadBtnHeader.style.display = 'inline-flex';
                    if (previewBtn) previewBtn.style.display = 'inline-flex';
                    
                    // Resetar botÃ£o para modo criar
                    const submitBtn = document.getElementById('submitButton');
                    submitBtn.title = 'Criar Damage Report com PDF';
                    submitBtn.style.background = '#10b981';
                    submitBtn.style.borderColor = '#10b981';
                    submitBtn.style.color = 'white';
                    
                    // Recarregar histÃ³rico
                    loadHistory();
                    
                    // Scroll para o topo
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    console.error('   âŒ ERRO! result.ok =', result.ok);
                    console.error('   Error:', result.error);
                    console.log('ðŸ’¾ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    showNotification('Erro ao criar Damage Report: ' + (result.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('ðŸ’¾ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.error('âŒ EXCEPTION ao guardar DR!');
                console.error('   Error:', error);
                console.error('   Message:', error.message);
                console.error('   Stack:', error.stack);
                console.error('ðŸ’¾ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                showNotification('Erro ao criar Damage Report: ' + error.message, 'error');
            }
        });

        // Date field - deixar vazio para user preencher manualmente
        // Comentado: nÃ£o forÃ§ar data atual
        // document.getElementById('date').valueAsDate = new Date();

        // ==================== EMAIL MODAL FUNCTIONS ====================
        let currentEmailDR = null;
        let additionalAttachments = []; // Array para guardar anexos adicionais

        function handleAdditionalAttachments(event) {
            const files = event.target.files;
            const maxFiles = 5;
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            if (additionalAttachments.length + files.length > maxFiles) {
                showNotification(`MÃ¡ximo de ${maxFiles} anexos adicionais permitidos`, 'warning');
                return;
            }
            
            Array.from(files).forEach(file => {
                if (file.size > maxSize) {
                    showNotification(`Arquivo ${file.name} excede 10MB`, 'warning');
                    return;
                }
                
                additionalAttachments.push(file);
            });
            
            updateAdditionalAttachmentsList();
            event.target.value = ''; // Limpar input
        }
        
        function updateAdditionalAttachmentsList() {
            const listDiv = document.getElementById('additionalAttachmentsList');
            
            if (additionalAttachments.length === 0) {
                listDiv.style.display = 'none';
                return;
            }
            
            listDiv.style.display = 'block';
            listDiv.innerHTML = '';
            
            additionalAttachments.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-top: 1px solid #e0f2fe;';
                
                const fileInfo = document.createElement('div');
                fileInfo.style.cssText = 'display: flex; align-items: center; gap: 8px; color: #374151; font-size: 12px;';
                fileInfo.innerHTML = `
                    <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>${file.name} (${(file.size / 1024).toFixed(0)} KB)</span>
                `;
                
                const removeBtn = document.createElement('button');
                removeBtn.style.cssText = 'background: #fee2e2; color: #dc2626; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; transition: all 0.2s;';
                removeBtn.textContent = 'Remover';
                removeBtn.onmouseover = () => removeBtn.style.background = '#fecaca';
                removeBtn.onmouseout = () => removeBtn.style.background = '#fee2e2';
                removeBtn.onclick = () => removeAdditionalAttachment(index);
                
                fileDiv.appendChild(fileInfo);
                fileDiv.appendChild(removeBtn);
                listDiv.appendChild(fileDiv);
            });
        }
        
        function removeAdditionalAttachment(index) {
            additionalAttachments.splice(index, 1);
            updateAdditionalAttachmentsList();
        }

        async function openEmailModal(drNumber, clientEmail, clientName, country) {
            // Limpar anexos anteriores
            additionalAttachments = [];
            updateAdditionalAttachmentsList();
            currentEmailDR = drNumber;
            
            // Preencher email do cliente
            document.getElementById('emailRecipient').value = clientEmail || '';
            
            // Mostrar modal
            document.getElementById('emailModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Carregar template do email
            try {
                // Buscar dados completos do DR para preencher template
                const drResponse = await fetch(`/api/damage-reports/${encodeURIComponent(drNumber)}`);
                const drData = await drResponse.json();
                
                let contractNumber = '';
                let vehiclePlate = '';
                let date = '';
                let clientCountry = '';
                
                if (drData.ok && drData.report) {
                    contractNumber = drData.report.contract_number || '';
                    vehiclePlate = drData.report.vehicle_plate || '';
                    date = drData.report.date || '';
                    clientCountry = drData.report.country || drData.report.client_country || country || '';
                }
                
                // Detectar idioma automaticamente do paÃ­s (usar dados do DR, nÃ£o parÃ¢metro)
                const langMap = {
                    'PT': 'pt', 'BR': 'pt',
                    'FR': 'fr', 'BE': 'fr', 'MC': 'fr',
                    'DE': 'de', 'AT': 'de', 'CH': 'de', 'LU': 'de'
                };
                const detectedLang = langMap[clientCountry?.toUpperCase()] || 'en';
                
                console.log(`Loading email template for ${drNumber}, language: ${detectedLang}, country: ${clientCountry}`);
                console.log(`DR data: RA=${contractNumber}, Plate=${vehiclePlate}, Date=${date}, Country=${clientCountry}`);
                
                // Carregar template do backend
                const response = await fetch(`/api/damage-reports/email-template/${detectedLang}`);
                const data = await response.json();
                
                if (data.ok && data.template) {
                    // Substituir parÃ¢metros no template
                    const firstName = clientName.split(' ')[0] || clientName;
                    
                    let subject = data.template.subject_template
                        .replace(/{drNumber}/g, drNumber)
                        .replace(/{firstName}/g, firstName)
                        .replace(/{vehiclePlate}/g, vehiclePlate);
                    
                    let body = data.template.body_template
                        .replace(/{drNumber}/g, drNumber)
                        .replace(/{firstName}/g, firstName)
                        .replace(/{email}/g, clientEmail || '')
                        .replace(/{clientName}/g, clientName || '')
                        .replace(/{contractNumber}/g, contractNumber)
                        .replace(/{raNumber}/g, contractNumber)
                        .replace(/{vehiclePlate}/g, vehiclePlate)
                        .replace(/{date}/g, date);
                    
                    // Mostrar preview (suporta HTML)
                    document.getElementById('emailSubjectPreview').textContent = subject;
                    
                    // Renderizar HTML completo no iframe
                    const iframe = document.getElementById('emailBodyPreview');
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(body);
                    iframeDoc.close();
                } else {
                    // Fallback template
                    document.getElementById('emailSubjectPreview').textContent = `Damage Report ${drNumber}`;
                    const iframe = document.getElementById('emailBodyPreview');
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(`<html><body style="font-family: Arial; padding: 20px;">Hello ${clientName},<br><br>Please find attached the Damage Report ${drNumber}.<br><br>Best regards,<br>Auto Prudente</body></html>`);
                    iframeDoc.close();
                }
                
                // Info de anexos
                document.getElementById('attachmentInfo').textContent = `Damage_Report_${drNumber.replace(/\//g, '_')}.pdf`;
                
            } catch (error) {
                console.error('Error loading email template:', error);
                document.getElementById('emailSubjectPreview').textContent = `Damage Report ${drNumber}`;
                const iframe = document.getElementById('emailBodyPreview');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write('<html><body style="font-family: Arial; padding: 20px; color: #dc2626;">âŒ Erro ao carregar template de email</body></html>');
                iframeDoc.close();
                document.getElementById('attachmentInfo').textContent = 'PDF anexado';
            }
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentEmailDR = null;
        }

        async function sendDREmail() {
            const recipientEmail = document.getElementById('emailRecipient').value;
            
            if (!recipientEmail) {
                showNotification('Por favor, insira o email do cliente', 'warning');
                return;
            }
            
            if (!currentEmailDR) {
                showNotification('Erro: DR nÃ£o identificado', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendEmailBtn');
            const originalContent = sendBtn.innerHTML;
            
            // Desabilitar botÃ£o
            sendBtn.disabled = true;
            sendBtn.innerHTML = `
                <svg style="width: 18px; height: 18px; animation: spin 1s linear infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span>A enviar...</span>
            `;
            
            try {
                // Obter dados do DR
                const drResponse = await fetch(`/api/damage-reports/${encodeURIComponent(currentEmailDR)}`);
                const drData = await drResponse.json();
                
                if (!drData.ok) {
                    throw new Error('Erro ao carregar dados do DR');
                }
                
                const report = drData.report;
                
                // Obter PDF em base64
                const pdfResponse = await fetch(`/api/damage-reports/${encodeURIComponent(currentEmailDR)}/pdf`);
                
                // Validar se a resposta Ã© realmente um PDF
                const contentType = pdfResponse.headers.get('Content-Type');
                if (!contentType || !contentType.includes('application/pdf')) {
                    // Se nÃ£o Ã© PDF, Ã© provÃ¡vel que seja um erro JSON
                    const errorText = await pdfResponse.text();
                    console.error('âŒ PDF endpoint returned non-PDF:', errorText);
                    throw new Error('PDF nÃ£o disponÃ­vel. Por favor, tente novamente.');
                }
                
                const pdfBlob = await pdfResponse.blob();
                
                // Validar tamanho do PDF (deve ser > 1KB)
                if (pdfBlob.size < 1000) {
                    throw new Error('PDF invÃ¡lido (muito pequeno). Por favor, regenere o DR.');
                }
                
                const pdfBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(pdfBlob);
                });
                
                // Converter anexos adicionais para base64
                const attachmentsData = [];
                for (const file of additionalAttachments) {
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });
                    attachmentsData.push({
                        name: file.name,
                        data: base64,
                        type: file.type || 'application/octet-stream'
                    });
                }
                
                // Enviar email
                const emailPayload = {
                    drNumber: currentEmailDR,
                    clientEmail: recipientEmail,
                    clientName: report.client_name || 'Cliente',
                    contractNumber: report.contract_number || '',
                    vehiclePlate: report.vehicle_plate || '',
                    date: report.date || new Date().toISOString().split('T')[0],
                    country: report.country || 'PT',
                    pdfData: pdfBase64,
                    attachments: attachmentsData
                };
                
                const response = await fetch('/api/damage-reports/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailPayload)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showNotification(`Email enviado com sucesso para ${recipientEmail}`, 'success');
                    closeEmailModal();
                } else {
                    showNotification('Erro ao enviar email: ' + (result.error || 'Desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showNotification('Erro ao enviar email: ' + error.message, 'error');
            } finally {
                // Restaurar botÃ£o
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalContent;
            }
        }

        // Fechar modal ao clicar fora
        document.getElementById('emailModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'emailModal') {
                closeEmailModal();
            }
        });
    </script>
    
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
