<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damage Report - Auto Prudente</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        body {
            background: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #009cb6;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 20px;
            color: #1f2937;
        }
        
        .icon-mono {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #009cb6;
            box-shadow: 0 0 0 3px rgba(0, 156, 182, 0.1);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #009cb6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #007a8f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 156, 182, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #009cb6;
            background: #f0f9fb;
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        /* CROQUI DO CARRO */
        .car-diagram-container {
            background: #f9fafb;
            border-radius: 12px;
            padding: 30px;
        }
        
        .car-view {
            position: relative;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .car-view h3 {
            text-align: center;
            color: #6b7280;
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        
        .car-svg-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .car-svg {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .damage-pin {
            position: absolute;
            width: 32px;
            height: 32px;
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
            transition: all 0.2s;
        }
        
        .damage-pin:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }
        
        .damage-list {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .damage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .damage-item:last-child {
            margin-bottom: 0;
        }
        
        .damage-number {
            width: 28px;
            height: 28px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }
        
        .damage-detail-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .damage-detail-row:hover {
            border-color: #009cb6;
            background: #f0f9fb;
        }
        
        .damage-detail-number {
            width: 40px;
            height: 40px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .damage-detail-input {
            flex: 1;
        }
        
        .damage-detail-input input {
            width: 100%;
            padding: 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .damage-detail-input input:focus {
            outline: none;
            border-color: #009cb6;
            box-shadow: 0 0 0 3px rgba(0, 156, 182, 0.1);
        }
        
        .damage-detail-delete {
            flex-shrink: 0;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <svg class="icon-mono" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Damage Report
            </h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="document.getElementById('raUploadInput').click()" title="Upload Rental Agreement">
                    <svg class="icon-mono" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Upload RA
                </button>
                <input type="file" id="raUploadInput" accept=".pdf" style="display: none;" onchange="handleRAUpload(event)">
                
                <button class="btn btn-primary" onclick="previewDR()" id="previewBtn" style="display: none;" title="Visualizar Damage Report">
                    <svg class="icon-mono" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Visualizar
                </button>
                
                <button class="btn btn-success" onclick="downloadPDF()" id="downloadBtnHeader" style="display: none;" title="Download PDF">
                    <svg class="icon-mono" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Download
                </button>
                
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    <svg class="icon-mono" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Voltar
                </button>
            </div>
        </div>

        <!-- Hist√≥rico de Damage Reports -->
        <div class="card">
            <div class="card-header">
                <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <h2>Hist√≥rico de Damage Reports</h2>
                <button type="button" class="btn btn-primary" onclick="loadHistory()" style="margin-left: auto;">
                    <svg class="icon-mono" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Atualizar
                </button>
            </div>
            
            <div id="historyList" style="max-height: 300px; overflow-y: auto;">
                <p style="text-align: center; color: #6b7280; padding: 20px;">
                    Carregando hist√≥rico...
                </p>
            </div>
        </div>

        <!-- Formul√°rio -->
        <form id="damageReportForm">
            <!-- Dados do Contrato -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h2>Dados do Contrato</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>N√∫mero do Contrato *</label>
                        <input type="text" id="contractNumber" name="contractNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                </div>
            </div>

            <!-- Dados do Cliente -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <h2>Dados do Cliente</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="clientName" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" name="clientEmail">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="clientPhone" name="clientPhone">
                    </div>
                    <div class="form-group">
                        <label>Morada</label>
                        <input type="text" id="address" name="address">
                    </div>
                    <div class="form-group">
                        <label>Cidade</label>
                        <input type="text" id="city" name="city">
                    </div>
                    <div class="form-group">
                        <label>C√≥digo Postal</label>
                        <input type="text" id="postalCode" name="postalCode">
                    </div>
                    <div class="form-group">
                        <label>Pa√≠s</label>
                        <input type="text" id="country" name="country">
                    </div>
                </div>
            </div>

            <!-- Dados do Ve√≠culo -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                    <h2>Dados do Ve√≠culo</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Matr√≠cula *</label>
                        <input type="text" id="vehiclePlate" name="vehiclePlate" required>
                    </div>
                    <div class="form-group">
                        <label>Modelo *</label>
                        <input type="text" id="vehicleModel" name="vehicleModel" required>
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="vehicleBrand" name="vehicleBrand">
                    </div>
                    <div class="form-group">
                        <label>Quilometragem</label>
                        <input type="number" id="mileage" name="mileage">
                    </div>
                    <div class="form-group">
                        <label>N√≠vel de Combust√≠vel</label>
                        <select id="fuelLevel" name="fuelLevel">
                            <option value="">Selecionar...</option>
                            <option value="empty">Vazio</option>
                            <option value="1/4">1/4</option>
                            <option value="1/2">1/2</option>
                            <option value="3/4">3/4</option>
                            <option value="full">Cheio</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Datas de Levantamento e Devolu√ß√£o -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <h2>Levantamento e Devolu√ß√£o</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Data de Levantamento</label>
                        <input type="date" id="pickupDate" name="pickupDate">
                    </div>
                    <div class="form-group">
                        <label>Hora de Levantamento</label>
                        <input type="time" id="pickupTime" name="pickupTime">
                    </div>
                    <div class="form-group">
                        <label>Local de Levantamento</label>
                        <input type="text" id="pickupLocation" name="pickupLocation" value="AUTO PRUDENTE">
                    </div>
                    <div class="form-group">
                        <label>Data de Devolu√ß√£o</label>
                        <input type="date" id="returnDate" name="returnDate">
                    </div>
                    <div class="form-group">
                        <label>Hora de Devolu√ß√£o</label>
                        <input type="time" id="returnTime" name="returnTime">
                    </div>
                    <div class="form-group">
                        <label>Local de Devolu√ß√£o</label>
                        <input type="text" id="returnLocation" name="returnLocation" value="AUTO PRUDENTE">
                    </div>
                </div>
            </div>

            <!-- Croqui do Carro -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #ef4444;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <h2>Croqui de Danos</h2>
                </div>
                
                <div class="car-diagram-container">
                    <p style="color: #6b7280; margin-bottom: 20px; text-align: center;">
                        üí° Clique no carro para adicionar pins de danos. Clique no pin para remover.
                    </p>
                    
                    <div class="car-view">
                        <div class="car-svg-container" id="carDiagram" onclick="addDamagePin(event, 'all')" style="position: relative;">
                            <img src="/static/images/Croqui.png" alt="Croqui do Carro" style="width: 100%; height: auto; display: block; max-width: 1000px; margin: 0 auto;">
                        </div>
                    </div>
                    
                    <div class="damage-list" id="damageList" style="display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Danos Registados:</h4>
                        <div id="damageItems"></div>
                    </div>
                </div>
            </div>

            <!-- Danos na Viatura -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #ef4444;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <h2>Danos na Viatura / Vehicle Damage</h2>
                </div>
                
                <div id="damageDetailsContainer" style="display: none;">
                    <p style="color: #6b7280; margin-bottom: 15px; font-size: 14px;">
                        üí° Cada n√∫mero do croqui corresponde a uma linha abaixo. Descreva o dano em detalhe.
                    </p>
                    <div id="damageDetailsList"></div>
                </div>
                
                <div id="noDamagesMessage" style="text-align: center; padding: 30px; color: #6b7280;">
                    <svg style="width: 48px; height: 48px; margin: 0 auto 15px; color: #d1d5db;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p style="margin: 0; font-size: 16px;">Nenhum dano marcado no croqui</p>
                    <p style="margin: 10px 0 0 0; font-size: 14px;">Clique no croqui acima para adicionar pins de danos</p>
                </div>
            </div>

            <!-- Observa√ß√µes -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon-mono" style="color: #009cb6;" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    <h2>Observa√ß√µes Adicionais</h2>
                </div>
                
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea id="observations" name="observations" placeholder="Outras observa√ß√µes relevantes sobre o ve√≠culo..."></textarea>
                </div>
            </div>

            <!-- Bot√µes -->
            <div class="action-buttons">
                <button type="button" class="btn btn-secondary" onclick="clearForm()">
                    <svg class="icon-mono" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Limpar
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadPDF()" id="downloadBtn" style="display: none;">
                    <svg class="icon-mono" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Download PDF
                </button>
                <button type="submit" class="btn btn-success">
                    <svg class="icon-mono" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                    </svg>
                    Guardar Damage Report
                </button>
            </div>
        </form>
    </div>

    <script>
        let damageCounter = 0;
        let damages = [];
        let currentDRNumber = null;

        // Carregar hist√≥rico ao iniciar
        window.addEventListener('load', () => {
            loadHistory();
        });

        // Carregar hist√≥rico de DRs
        async function loadHistory() {
            try {
                const response = await fetch('/api/damage-reports/list');
                const data = await response.json();
                
                const historyList = document.getElementById('historyList');
                
                if (data.ok && data.reports && data.reports.length > 0) {
                    historyList.innerHTML = data.reports.map(report => `
                        <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s;" 
                             onmouseover="this.style.background='#f9fafb'" 
                             onmouseout="this.style.background='white'"
                             onclick="loadDR('${report.dr_number}')">
                            <div>
                                <strong style="color: #009cb6; font-size: 16px;">DR ${report.dr_number}</strong>
                                <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 13px;">
                                    ${report.client_name || 'N/A'} ‚Ä¢ ${report.vehicle_plate || 'N/A'} ‚Ä¢ ${report.date || 'N/A'}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="event.stopPropagation(); downloadDRPDF('${report.dr_number}')">
                                    <svg class="icon-mono" style="width: 16px; height: 16px;" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    PDF
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Nenhum Damage Report criado ainda.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Erro ao carregar hist√≥rico.</p>';
            }
        }

        // Carregar DR espec√≠fico
        async function loadDR(drNumber) {
            try {
                const response = await fetch(`/api/damage-reports/${drNumber}`);
                const data = await response.json();
                
                if (data.ok && data.report) {
                    const r = data.report;
                    currentDRNumber = drNumber;
                    
                    // Preencher formul√°rio
                    if (r.contract_number) document.getElementById('contractNumber').value = r.contract_number;
                    if (r.date) document.getElementById('date').value = r.date;
                    if (r.client_name) document.getElementById('clientName').value = r.client_name;
                    if (r.client_email) document.getElementById('clientEmail').value = r.client_email;
                    if (r.client_phone) document.getElementById('clientPhone').value = r.client_phone;
                    if (r.client_address) document.getElementById('address').value = r.client_address;
                    if (r.client_city) document.getElementById('city').value = r.client_city;
                    if (r.client_postal_code) document.getElementById('postalCode').value = r.client_postal_code;
                    if (r.vehicle_plate) document.getElementById('vehiclePlate').value = r.vehicle_plate;
                    if (r.vehicle_model) document.getElementById('vehicleModel').value = r.vehicle_model;
                    if (r.vehicle_brand) document.getElementById('vehicleBrand').value = r.vehicle_brand;
                    if (r.mileage) document.getElementById('mileage').value = r.mileage;
                    if (r.fuel_level) document.getElementById('fuelLevel').value = r.fuel_level;
                    if (r.pickup_date) document.getElementById('pickupDate').value = r.pickup_date.split('T')[0];
                    if (r.return_date) document.getElementById('returnDate').value = r.return_date.split('T')[0];
                    if (r.pickup_location) document.getElementById('pickupLocation').value = r.pickup_location;
                    if (r.return_location) document.getElementById('returnLocation').value = r.return_location;
                    if (r.damage_description) document.getElementById('damageDescription').value = r.damage_description;
                    if (r.observations) document.getElementById('observations').value = r.observations;
                    
                    // Mostrar bot√µes
                    document.getElementById('downloadBtn').style.display = 'inline-flex';
                    document.getElementById('downloadBtnHeader').style.display = 'inline-flex';
                    document.getElementById('previewBtn').style.display = 'inline-flex';
                    
                    // Scroll para o formul√°rio
                    document.getElementById('damageReportForm').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Erro ao carregar DR:', error);
                alert('‚ùå Erro ao carregar Damage Report');
            }
        }

        // Download PDF do DR
        async function downloadDRPDF(drNumber) {
            window.open(`/api/damage-reports/${drNumber}/pdf`, '_blank');
        }

        function downloadPDF() {
            if (currentDRNumber) {
                downloadDRPDF(currentDRNumber);
            }
        }

        // Upload RA
        async function handleRAUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Mostrar loading
            const uploadBtn = event.target.previousElementSibling;
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<span style="display: flex; align-items: center; gap: 8px;"><svg class="icon-mono" style="animation: spin 1s linear infinite;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>Extraindo...</span>';
            uploadBtn.disabled = true;
            
            try {
                const response = await fetch('/api/damage-reports/extract-from-ra', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.ok && data.fields) {
                    const fields = data.fields;
                    if (fields.contractNumber) document.getElementById('contractNumber').value = fields.contractNumber;
                    if (fields.clientName) document.getElementById('clientName').value = fields.clientName;
                    if (fields.clientEmail) document.getElementById('clientEmail').value = fields.clientEmail;
                    if (fields.clientPhone) document.getElementById('clientPhone').value = fields.clientPhone;
                    if (fields.vehiclePlate) document.getElementById('vehiclePlate').value = fields.vehiclePlate;
                    if (fields.vehicleModel) document.getElementById('vehicleModel').value = fields.vehicleModel;
                    if (fields.vehicleBrand) document.getElementById('vehicleBrand').value = fields.vehicleBrand;
                    if (fields.address) document.getElementById('address').value = fields.address;
                    if (fields.city) document.getElementById('city').value = fields.city;
                    if (fields.postalCode) document.getElementById('postalCode').value = fields.postalCode;
                    if (fields.country) document.getElementById('country').value = fields.country;
                    if (fields.mileage) document.getElementById('mileage').value = fields.mileage;
                    if (fields.pickupDate) {
                        const parts = fields.pickupDate.split('-');
                        document.getElementById('pickupDate').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                    if (fields.returnDate) {
                        const parts = fields.returnDate.split('-');
                        document.getElementById('returnDate').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                    if (fields.pickupTime) document.getElementById('pickupTime').value = fields.pickupTime;
                    if (fields.returnTime) document.getElementById('returnTime').value = fields.returnTime;
                    if (fields.pickupLocation) document.getElementById('pickupLocation').value = fields.pickupLocation;
                    if (fields.returnLocation) document.getElementById('returnLocation').value = fields.returnLocation;
                    
                    alert('‚úÖ Dados extra√≠dos com sucesso do Rental Agreement!');
                    
                    // Scroll para o formul√°rio
                    document.getElementById('damageReportForm').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('‚ùå Erro ao extrair dados: ' + (data.error || 'Desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao fazer upload');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
                event.target.value = '';
            }
        }

        // Preview do DR
        function previewDR() {
            if (!currentDRNumber) {
                alert('‚ö†Ô∏è Guarde o Damage Report primeiro para poder visualiz√°-lo');
                return;
            }
            
            // Criar modal de preview
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;';
            
            // Bot√£o fechar
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '‚úï';
            closeBtn.style.cssText = 'position: absolute; top: 15px; right: 15px; background: #ef4444; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold;';
            closeBtn.onclick = () => modal.remove();
            
            // Conte√∫do do preview
            const formData = new FormData(document.getElementById('damageReportForm'));
            const data = Object.fromEntries(formData);
            
            content.innerHTML = `
                <h2 style="color: #009cb6; margin: 0 0 20px 0; padding-right: 40px;">üìÑ Preview - DR ${currentDRNumber}</h2>
                
                <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin: 0 0 15px 0; border-bottom: 2px solid #009cb6; padding-bottom: 10px;">üìã Dados do Contrato</h3>
                    <p><strong>Contrato:</strong> ${data.contractNumber || 'N/A'}</p>
                    <p><strong>Data:</strong> ${data.date || 'N/A'}</p>
                </div>
                
                <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin: 0 0 15px 0; border-bottom: 2px solid #009cb6; padding-bottom: 10px;">üë§ Dados do Cliente</h3>
                    <p><strong>Nome:</strong> ${data.clientName || 'N/A'}</p>
                    <p><strong>Email:</strong> ${data.clientEmail || 'N/A'}</p>
                    <p><strong>Telefone:</strong> ${data.clientPhone || 'N/A'}</p>
                    <p><strong>Morada:</strong> ${data.address || 'N/A'}</p>
                    <p><strong>Cidade:</strong> ${data.city || 'N/A'} - ${data.postalCode || 'N/A'}</p>
                    <p><strong>Pa√≠s:</strong> ${data.country || 'N/A'}</p>
                </div>
                
                <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin: 0 0 15px 0; border-bottom: 2px solid #009cb6; padding-bottom: 10px;">üöó Dados do Ve√≠culo</h3>
                    <p><strong>Matr√≠cula:</strong> ${data.vehiclePlate || 'N/A'}</p>
                    <p><strong>Modelo:</strong> ${data.vehicleModel || 'N/A'}</p>
                    <p><strong>Marca:</strong> ${data.vehicleBrand || 'N/A'}</p>
                    <p><strong>Quilometragem:</strong> ${data.mileage || 'N/A'} km</p>
                    <p><strong>Combust√≠vel:</strong> ${data.fuelLevel || 'N/A'}</p>
                </div>
                
                <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin: 0 0 15px 0; border-bottom: 2px solid #009cb6; padding-bottom: 10px;">üìÖ Levantamento e Devolu√ß√£o</h3>
                    <p><strong>Levantamento:</strong> ${data.pickupDate || 'N/A'} √†s ${data.pickupTime || 'N/A'}</p>
                    <p><strong>Local:</strong> ${data.pickupLocation || 'N/A'}</p>
                    <p><strong>Devolu√ß√£o:</strong> ${data.returnDate || 'N/A'} √†s ${data.returnTime || 'N/A'}</p>
                    <p><strong>Local:</strong> ${data.returnLocation || 'N/A'}</p>
                </div>
                
                ${damages.length > 0 ? `
                <div style="border: 2px solid #ef4444; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #ef4444; margin: 0 0 15px 0; border-bottom: 2px solid #ef4444; padding-bottom: 10px;">‚ö†Ô∏è Danos Registados</h3>
                    ${damages.sort((a, b) => a.number - b.number).map(d => `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 30px; height: 30px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${d.number}</div>
                            <p style="margin: 0;">${d.description || 'Sem descri√ß√£o'}</p>
                        </div>
                    `).join('')}
                </div>
                ` : '<p style="text-align: center; color: #6b7280; padding: 20px;">Nenhum dano registado</p>'}
                
                ${data.observations ? `
                <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #374151; margin: 0 0 15px 0; border-bottom: 2px solid #009cb6; padding-bottom: 10px;">üìù Observa√ß√µes</h3>
                    <p>${data.observations}</p>
                </div>
                ` : ''}
            `;
            
            content.insertBefore(closeBtn, content.firstChild);
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        // Adicionar pin de dano
        function addDamagePin(event, view) {
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            damageCounter++;
            const damageId = `damage-${view}-${damageCounter}`;
            
            // Criar pin
            const pin = document.createElement('div');
            pin.className = 'damage-pin';
            pin.id = damageId;
            pin.textContent = damageCounter;
            pin.style.left = x + 'px';
            pin.style.top = y + 'px';
            pin.onclick = (e) => {
                e.stopPropagation();
                removeDamagePin(damageId);
            };
            
            container.appendChild(pin);
            
            // Adicionar √† lista
            damages.push({
                id: damageId,
                number: damageCounter,
                view: view,
                x: x,
                y: y
            });
            
            updateDamageList();
        }

        // Remover pin
        function removeDamagePin(damageId) {
            const pin = document.getElementById(damageId);
            if (pin) pin.remove();
            
            damages = damages.filter(d => d.id !== damageId);
            updateDamageList();
        }

        // Atualizar lista de danos
        function updateDamageList() {
            const list = document.getElementById('damageList');
            const items = document.getElementById('damageItems');
            
            if (damages.length === 0) {
                list.style.display = 'none';
                updateDamageDetails();
                return;
            }
            
            list.style.display = 'block';
            items.innerHTML = damages.map(d => `
                <div class="damage-item">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="damage-number">${d.number}</div>
                        <span><strong>Dano #${d.number}</strong></span>
                    </div>
                    <button type="button" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="removeDamagePin('${d.id}')">
                        Remover
                    </button>
                </div>
            `).join('');
            
            updateDamageDetails();
        }
        
        // Atualizar campos de descri√ß√£o de danos
        function updateDamageDetails() {
            const container = document.getElementById('damageDetailsContainer');
            const detailsList = document.getElementById('damageDetailsList');
            const noMessage = document.getElementById('noDamagesMessage');
            
            if (damages.length === 0) {
                container.style.display = 'none';
                noMessage.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            noMessage.style.display = 'none';
            
            // Ordenar por n√∫mero
            const sortedDamages = [...damages].sort((a, b) => a.number - b.number);
            
            detailsList.innerHTML = sortedDamages.map(d => `
                <div class="damage-detail-row" id="detail-${d.id}">
                    <div class="damage-detail-number">${d.number}</div>
                    <div class="damage-detail-input">
                        <input 
                            type="text" 
                            id="damage-desc-${d.number}" 
                            name="damage-desc-${d.number}"
                            placeholder="Ex: Risco no para-choques dianteiro, lado esquerdo"
                            value="${d.description || ''}"
                            onchange="updateDamageDescription(${d.number}, this.value)"
                        >
                    </div>
                    <div class="damage-detail-delete">
                        <button type="button" class="btn btn-secondary" style="padding: 10px 12px;" onclick="removeDamagePin('${d.id}')" title="Remover dano">
                            <svg class="icon-mono" style="width: 20px; height: 20px;" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Atualizar descri√ß√£o de um dano
        function updateDamageDescription(damageNumber, description) {
            const damage = damages.find(d => d.number === damageNumber);
            if (damage) {
                damage.description = description;
            }
        }

        // Limpar formul√°rio
        function clearForm() {
            if (confirm('Tem a certeza que deseja limpar todos os campos?')) {
                document.getElementById('damageReportForm').reset();
                damages = [];
                damageCounter = 0;
                document.querySelectorAll('.damage-pin').forEach(pin => pin.remove());
                updateDamageList();
                document.getElementById('raFileName').textContent = '';
            }
        }

        // Submit
        document.getElementById('damageReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Adicionar dados dos danos
            data.damageDiagramData = JSON.stringify(damages);
            
            // Criar descri√ß√£o completa dos danos
            const damageDescriptions = damages
                .sort((a, b) => a.number - b.number)
                .map(d => `${d.number}. ${d.description || 'Sem descri√ß√£o'}`)
                .join('\n');
            
            data.damageDescription = damageDescriptions;
            
            try {
                const response = await fetch('/api/damage-reports/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    currentDRNumber = result.dr_number;
                    alert(`‚úÖ Damage Report ${result.dr_number} criado com sucesso!`);
                    
                    // Mostrar bot√µes no header e no formul√°rio
                    document.getElementById('downloadBtn').style.display = 'inline-flex';
                    document.getElementById('downloadBtnHeader').style.display = 'inline-flex';
                    document.getElementById('previewBtn').style.display = 'inline-flex';
                    
                    // Recarregar hist√≥rico
                    loadHistory();
                    
                    // Scroll para o topo
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    alert('‚ùå Erro: ' + (result.error || 'Desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao guardar');
            }
        });

        // Set today's date
        document.getElementById('date').valueAsDate = new Date();
    </script>
</body>
</html>
