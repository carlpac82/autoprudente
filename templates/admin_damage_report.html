<!doctype html>
<html lang="pt">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin ‚Ä¢ Relat√≥rio de Danos</title>
    <link rel="icon" type="image/png" href="/static/autoprudente-favicon.png?v=2" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Hide header if in iframe
        if (window.location.search.includes('iframe=1')) {
            document.addEventListener('DOMContentLoaded', function() {
                const header = document.querySelector('header');
                if (header) header.style.display = 'none';
                
                // Adjust main padding
                const main = document.querySelector('main');
                if (main) {
                    main.style.maxWidth = '100%';
                    main.style.padding = '1rem';
                }
            });
        }
    </script>
    <style>
        * { 
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        img[alt="Profile"], img[src*="profile"], .profile-picture {
            border-radius: 50% !important;
        }
        .action-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-icon:hover {
            border-color: #009cb6;
            background: #f0f9fb;
            transform: translateY(-2px);
        }
        .action-icon svg {
            width: 24px;
            height: 24px;
            stroke: #6b7280;
            stroke-width: 1.5;
        }
        .action-icon:hover svg {
            stroke: #009cb6;
        }
        .section-card {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #009cb6;
        }
        .section-header svg {
            width: 24px;
            height: 24px;
            stroke: #009cb6;
            stroke-width: 1.5;
        }
        .section-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-[#009cb6] border-b">
        <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/"><img src="/static/ap-heather.png" alt="Auto Prudente" class="h-12 w-auto" /></a>
            </div>
            <nav class="flex items-center gap-3 text-white text-sm">
                <a href="/" class="hover:underline">Prices</a>
                <span class="opacity-90">Admin Menu</span>
                <form method="post" action="/logout"><button class="hover:underline">Logout</button></form>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="mx-auto max-w-7xl px-4 py-6">
        <!-- Page Title -->
        <div class="mb-6 flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-semibold text-gray-800">Relat√≥rio de Danos</h2>
                <p class="text-sm text-gray-500 mt-1">Configura√ß√µes e mapeamento de campos do PDF</p>
            </div>
            <button onclick="openFullscreen()" class="action-icon" title="Abrir em ecr√£ completo">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                </svg>
            </button>
        </div>

        <!-- Mapper Section -->
        <div class="section-card">
            <div class="section-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                </svg>
                <h3>Mapear Campos PDF</h3>
                <span class="ml-auto text-sm text-gray-500">{{ mapped_fields }} / 38 campos</span>
            </div>
            
            <div class="flex items-center justify-between">
                <p class="text-sm text-gray-600">Define as posi√ß√µes dos campos no template PDF</p>
                <button onclick="toggleMapper()" id="toggleMapperBtn" class="action-icon" title="Mostrar/Esconder Mapeador">
                    <svg id="toggleIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            
            <!-- Iframe Container (Hidden by default) -->
            <div id="mapperContainer" style="display: none; margin-top: 1.5rem;">
                <div class="border border-gray-200" style="height: 800px; position: relative;">
                    <!-- Loading indicator -->
                    <div id="iframeLoading" style="position: absolute; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 10;">
                        <div style="text-align: center;">
                            <svg style="width: 48px; height: 48px; stroke: #009cb6; animation: spin 1s linear infinite;" fill="none" viewBox="0 0 24 24">
                                <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">Carregando mapeador...</p>
                        </div>
                    </div>
                    <iframe id="mapperIframe" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
            <style>
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            </style>
        </div>

        <!-- Upload PDFs para DRs Existentes -->
        <div class="section-card">
            <div class="section-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                <h3>Upload PDFs Existentes</h3>
            </div>
            
            <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0284c7;">
                <p class="text-sm text-gray-700 mb-2"><strong>üìÑ Upload em Massa dos 39 PDFs!</strong></p>
                <p class="text-xs text-gray-600 mb-2">Seleciona todos os PDFs de uma vez. O n√∫mero do DR ser√° detectado automaticamente do nome do ficheiro.</p>
                <p class="text-xs text-gray-500">‚úÖ Formatos aceites: DR_01_2025.pdf, DR-01-2025.pdf, DR 01 2025.pdf, 01_2025.pdf, etc.</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar M√∫ltiplos PDFs</label>
                <input type="file" id="pdfBulkFileInput" accept=".pdf" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                <p class="text-xs text-gray-500 mt-2" id="fileCount">Nenhum ficheiro selecionado</p>
            </div>
            
            <button onclick="uploadPdfsBulk()" class="btn btn-primary" style="background: #0284c7; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; width: 100%; margin-bottom: 10px;">
                üì§ Upload Todos os PDFs
            </button>
            
            <details style="margin-top: 10px;">
                <summary style="cursor: pointer; color: #6b7280; font-size: 13px; padding: 8px; background: #f9fafb; border-radius: 4px;">
                    ‚ûï Upload Individual (opcional)
                </summary>
                <div style="margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero do DR</label>
                            <input type="text" id="pdfDrNumber" placeholder="DR 01/2025" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ficheiro PDF</label>
                            <input type="file" id="pdfFileInput" accept=".pdf" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>
                    <button onclick="uploadPdfToDR()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; width: 100%;">
                        Upload Individual
                    </button>
                </div>
            </details>
            
            <div id="pdfUploadStatus" style="margin-top: 15px; display: none;"></div>
        </div>

        <!-- Importar Damage Reports Existentes -->
        <div class="section-card">
            <div class="section-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                </svg>
                <h3>Importar DRs Existentes</h3>
            </div>
            
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                <p class="text-sm text-gray-700 mb-2"><strong>üìã Tens 39 Damage Reports existentes?</strong></p>
                <p class="text-xs text-gray-600">Importa-os em formato JSON para aparecerem no hist√≥rico. Formato esperado:</p>
                <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 11px; margin-top: 8px; overflow-x: auto;">
{
  "reports": [
    {
      "dr_number": "DR 01/2025",
      "contract_number": "RA12345",
      "client_name": "Jo√£o Silva",
      "vehicle_plate": "AA-00-BB",
      ...
    }
  ]
}</pre>
            </div>
            
            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
            <button onclick="document.getElementById('importFileInput').click()" class="btn btn-primary" style="background: #009cb6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; width: 100%;">
                üì• Selecionar Ficheiro JSON
            </button>
            
            <div id="importStatus" style="margin-top: 15px; display: none;"></div>
        </div>

        <!-- Configura√ß√£o de Numera√ß√£o -->
        <div class="section-card">
            <div class="section-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                </svg>
                <h3>Numera√ß√£o Autom√°tica</h3>
            </div>
            
            <div style="background: #f0f9fb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p class="text-sm text-gray-600 mb-3">Pr√≥ximo DR ser√°: <strong id="nextDRNumber" style="color: #009cb6; font-size: 1.1rem;">DR 41/2025</strong></p>
                <p class="text-xs text-gray-500">Reset autom√°tico dia 1 de Janeiro para DR 01/XXXX</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prefixo</label>
                    <input type="text" id="drPrefix" value="DR" class="w-full px-3 py-2 border border-gray-300 rounded-md" maxlength="10">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero Atual</label>
                    <input type="number" id="drCurrentNumber" value="40" class="w-full px-3 py-2 border border-gray-300 rounded-md" min="1">
                </div>
            </div>
            
            <button onclick="updateDRNumbering()" class="btn btn-primary mt-4" style="background: #009cb6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; width: 100%;">
                Atualizar Numera√ß√£o
            </button>
        </div>

        <!-- Actions Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Upload Template -->
            <div class="section-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6" style="stroke: #009cb6; stroke-width: 1.5;" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <div>
                            <h4 class="font-medium text-gray-800">Upload Template</h4>
                            <p class="text-xs text-gray-500" id="templateInfo">Vers√£o 1 ‚Ä¢ 2 p√°ginas</p>
                        </div>
                    </div>
                    <button onclick="selectTemplateFile()" class="action-icon" title="Selecionar PDF">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                    </button>
                </div>
                <input type="file" id="templateFileInput" accept=".pdf" class="hidden">
                <input type="text" id="templateNotes" placeholder="Notas (opcional)" class="w-full px-3 py-2 border border-gray-200 text-sm" style="outline: none; transition: border-color 0.2s;">
            </div>

            <!-- Download Coordinates -->
            <div class="section-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6" style="stroke: #009cb6; stroke-width: 1.5;" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        <div>
                            <h4 class="font-medium text-gray-800">Download</h4>
                            <p class="text-xs text-gray-500">Coordenadas JSON</p>
                        </div>
                    </div>
                    <button onclick="downloadCoordinates()" class="action-icon" title="Download Coordenadas">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-600">Exportar ficheiro de coordenadas</p>
            </div>

            <!-- Upload Coordinates -->
            <div class="section-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6" style="stroke: #009cb6; stroke-width: 1.5;" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        <div>
                            <h4 class="font-medium text-gray-800">Upload</h4>
                            <p class="text-xs text-gray-500">Coordenadas JSON</p>
                        </div>
                    </div>
                    <button onclick="uploadCoordinates()" class="action-icon" title="Upload Coordenadas">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-600">Importar ficheiro de coordenadas</p>
            </div>
        </div>

        <!-- Current Coordinates Table -->
        <div class="section-card">
            <div class="section-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <h3>Campos Mapeados</h3>
                <span class="ml-auto text-sm text-gray-500">{{ mapped_fields }} campos</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb;">
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">Campo</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">Tipo</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">P√°g</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">Posi√ß√£o</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">Dimens√µes</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="coordinatesTableBody" style="border-top: none;">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Hidden File Inputs -->
    <input type="file" id="templateFileInput" accept=".pdf" style="display: none;">
    <input type="file" id="coordinatesFileInput" accept=".json" style="display: none;">

    <script>
        // Load coordinates on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadCoordinates();
            loadDRNumbering();
            
            // Listener para mostrar contagem de ficheiros
            const bulkInput = document.getElementById('pdfBulkFileInput');
            if (bulkInput) {
                bulkInput.addEventListener('change', (e) => {
                    const count = e.target.files.length;
                    document.getElementById('fileCount').textContent = count > 0 
                        ? `${count} ficheiro${count > 1 ? 's' : ''} selecionado${count > 1 ? 's' : ''}`
                        : 'Nenhum ficheiro selecionado';
                });
            }
            
            // Listen for messages from iframe
            window.addEventListener('message', (event) => {
                if (event.data.type === 'coordinatesSaved') {
                    loadCoordinates();
                    showSuccessMessage();
                }
            });
        });

        function toggleMapper() {
            const container = document.getElementById('mapperContainer');
            const iframe = document.getElementById('mapperIframe');
            const icon = document.getElementById('toggleIcon');
            const loading = document.getElementById('iframeLoading');
            
            if (container.style.display === 'none') {
                // Show mapper
                container.style.display = 'block';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"/>';
                
                // Load iframe if not loaded
                if (!iframe.src) {
                    loading.style.display = 'flex';
                    iframe.src = '/damage-report-mapper';
                    
                    // Hide loading when iframe loads
                    iframe.onload = function() {
                        loading.style.display = 'none';
                    };
                    
                    // Timeout fallback (10 seconds)
                    setTimeout(() => {
                        if (loading.style.display !== 'none') {
                            loading.style.display = 'none';
                            showErrorMessage('Mapeador demorou muito a carregar. Tenta recarregar a p√°gina.');
                        }
                    }, 10000);
                }
            } else {
                // Hide mapper
                container.style.display = 'none';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>';
            }
        }

        function showSuccessMessage(text = 'Coordenadas guardadas com sucesso!') {
            const msg = document.createElement('div');
            msg.style.cssText = 'position: fixed; top: 1rem; right: 1rem; background: white; border: 2px solid #009cb6; padding: 1rem 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999; display: flex; align-items: center; gap: 0.75rem;';
            msg.innerHTML = `
                <svg style="width: 24px; height: 24px; stroke: #009cb6; stroke-width: 2; flex-shrink: 0;" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span style="color: #1f2937; font-weight: 500;">${text}</span>
            `;
            document.body.appendChild(msg);
            
            setTimeout(() => {
                msg.style.opacity = '0';
                msg.style.transition = 'opacity 0.3s';
                setTimeout(() => msg.remove(), 300);
            }, 3000);
        }
        
        function showErrorMessage(text) {
            const msg = document.createElement('div');
            msg.style.cssText = 'position: fixed; top: 1rem; right: 1rem; background: white; border: 2px solid #ef4444; padding: 1rem 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999; display: flex; align-items: center; gap: 0.75rem;';
            msg.innerHTML = `
                <svg style="width: 24px; height: 24px; stroke: #ef4444; stroke-width: 2; flex-shrink: 0;" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span style="color: #1f2937; font-weight: 500;">${text}</span>
            `;
            document.body.appendChild(msg);
            
            setTimeout(() => {
                msg.style.opacity = '0';
                msg.style.transition = 'opacity 0.3s';
                setTimeout(() => msg.remove(), 300);
            }, 3000);
        }

        async function loadCoordinates() {
            try {
                const response = await fetch('/api/damage-reports/get-coordinates');
                const data = await response.json();
                
                if (data.ok && data.coordinates) {
                    displayCoordinates(data.coordinates);
                }
            } catch (error) {
                console.error('Error loading coordinates:', error);
            }
        }

        function displayCoordinates(coordinates) {
            const tbody = document.getElementById('coordinatesTableBody');
            tbody.innerHTML = '';

            const fieldNames = {
                'dr_number': 'DR N¬∫',
                'date': 'Data',
                'client_name': 'Nome do Cliente',
                'client_email': 'Email',
                'client_phone': 'Telefone',
                'client_address': 'Morada',
                'client_postal_code': 'C√≥digo Postal',
                'client_city': 'Cidade',
                'client_country': 'Pa√≠s',
                'vehicle_plate': 'Matr√≠cula',
                'vehicle_brand': 'Marca',
                'vehicle_model': 'Modelo',
                'pickup_date': 'Data Levantamento',
                'pickup_time': 'Hora Levantamento',
                'pickup_location': 'Local Levantamento',
                'return_date': 'Data Devolu√ß√£o',
                'return_time': 'Hora Devolu√ß√£o',
                'return_location': 'Local Devolu√ß√£o',
                'issued_by': 'Feito por',
                'damage_description': 'Descri√ß√£o Danos',
                'damage_diagram': 'Diagrama',
                'repair_table_header': 'Tabela - Cabe√ßalho',
                'repair_line_1': 'Repara√ß√£o - Linha 1',
                'repair_line_2': 'Repara√ß√£o - Linha 2',
                'repair_line_3': 'Repara√ß√£o - Linha 3',
                'repair_line_4': 'Repara√ß√£o - Linha 4',
                'repair_line_5': 'Repara√ß√£o - Linha 5',
                'repair_total': 'Tabela - Total',
                'images_area': '√Årea Imagens'
            };

            const typeIcons = {
                'text': 'üìù',
                'textarea': 'üìÑ',
                'table': 'üìä',
                'image': 'üñºÔ∏è',
                'images': 'üì∏'
            };

            for (const [fieldId, coord] of Object.entries(coordinates)) {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f3f4f6';
                row.style.transition = 'background-color 0.2s';
                row.onmouseenter = () => row.style.backgroundColor = '#f9fafb';
                row.onmouseleave = () => row.style.backgroundColor = 'white';
                
                const fieldName = fieldNames[fieldId] || fieldId;
                const type = getFieldType(fieldId);
                const icon = typeIcons[type] || 'üìù';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${icon} ${fieldName}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${type}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-center">${coord.page || 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${coord.x.toFixed(1)}, ${coord.y.toFixed(1)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${coord.width.toFixed(1)} √ó ${coord.height.toFixed(1)}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="editField('${fieldId}')" style="color: #009cb6; transition: color 0.2s;" onmouseover="this.style.color='#f6b511'" onmouseout="this.style.color='#009cb6'">Editar</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }

        function getFieldType(fieldId) {
            if (fieldId.includes('description')) return 'textarea';
            if (fieldId.includes('diagram')) return 'image';
            if (fieldId.includes('repair') || fieldId.includes('table')) return 'table';
            if (fieldId.includes('images')) return 'images';
            return 'text';
        }

        function openMapper() {
            window.location.href = '/damage-report?tab=mapper';
        }

        function selectTemplateFile() {
            const input = document.getElementById('templateFileInput');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await uploadTemplate(file);
                }
            };
            input.click();
        }

        async function uploadTemplate(file) {
            try {
                const notes = document.getElementById('templateNotes').value;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('notes', notes);
                
                const response = await fetch('/api/damage-reports/upload-template', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    // Atualizar info do template
                    document.getElementById('templateInfo').textContent = 
                        `Vers√£o ${result.version} ‚Ä¢ ${result.num_pages} p√°ginas`;
                    
                    // Limpar form
                    document.getElementById('templateNotes').value = '';
                    document.getElementById('templateFileInput').value = '';
                    
                    // Regenerar grid automaticamente
                    showSuccessMessage(`Template v${result.version} carregado! Regenerando grid...`);
                    const gridSuccess = await regenerateGrid();
                    
                    if (gridSuccess) {
                        // Abrir mapeador automaticamente
                        const container = document.getElementById('mapperContainer');
                        const iframe = document.getElementById('mapperIframe');
                        const icon = document.getElementById('toggleIcon');
                        const loading = document.getElementById('iframeLoading');
                        
                        if (container.style.display === 'none') {
                            container.style.display = 'block';
                            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"/>';
                        }
                        
                        // Mostrar loading
                        loading.style.display = 'flex';
                        
                        // Aguardar um pouco para o ficheiro ser escrito
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Carregar iframe com p√°gina dedicada do mapeador
                        iframe.src = '/damage-report-mapper?t=' + Date.now();
                        
                        // Esconder loading quando carregar
                        iframe.onload = function() {
                            loading.style.display = 'none';
                        };
                        
                        // Scroll suave para o mapeador
                        setTimeout(() => {
                            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 500);
                        
                        showSuccessMessage('PDF pronto para mapear!');
                    } else {
                        showErrorMessage('Grid regenerado mas pode haver problemas. Tenta recarregar a p√°gina.');
                    }
                } else {
                    showErrorMessage('Erro ao carregar template: ' + result.error);
                }
            } catch (error) {
                console.error('Error uploading template:', error);
                showErrorMessage('Erro ao carregar template');
            }
        }

        async function regenerateGrid() {
            try {
                console.log('Regenerating grid...');
                
                const response = await fetch('/api/damage-reports/regenerate-grid', {
                    method: 'POST'
                });
                
                const result = await response.json();
                console.log('Grid regeneration result:', result);
                
                if (result.ok) {
                    console.log(`Grid regenerated successfully: ${result.pages} pages`);
                    return true;
                } else {
                    console.error('Grid regeneration failed:', result.error);
                    showErrorMessage('Erro ao regenerar grid: ' + result.error);
                    return false;
                }
            } catch (error) {
                console.error('Error regenerating grid:', error);
                showErrorMessage('Erro ao regenerar grid');
                return false;
            }
        }

        function uploadCoordinates() {
            document.getElementById('coordinatesFileInput').click();
        }

        async function downloadCoordinates() {
            window.location.href = '/api/damage-reports/download-coordinates';
        }

        function openFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        function editField(fieldId) {
            window.location.href = `/damage-report?tab=mapper&field=${fieldId}`;
        }

        async function loadDRNumbering() {
            try {
                const response = await fetch('/api/damage-reports/numbering/get');
                const data = await response.json();
                
                if (data.ok) {
                    document.getElementById('drPrefix').value = data.prefix || 'DR';
                    document.getElementById('drCurrentNumber').value = data.current_number || 1;
                    document.getElementById('nextDRNumber').textContent = data.next_number || 'DR 01/2025';
                }
            } catch (error) {
                console.error('Error loading DR numbering:', error);
            }
        }

        async function uploadPdfsBulk() {
            const fileInput = document.getElementById('pdfBulkFileInput');
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                showErrorMessage('Por favor seleciona pelo menos um ficheiro PDF');
                return;
            }
            
            const statusDiv = document.getElementById('pdfUploadStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `<p style="color: #6b7280;">üì§ A fazer upload de ${files.length} ficheiros...</p>`;
            
            try {
                const formData = new FormData();
                
                // Adicionar todos os ficheiros
                for (let i = 0; i < files.length; i++) {
                    formData.append(`files${i}`, files[i]);
                }
                
                const response = await fetch('/api/damage-reports/upload-pdfs-bulk', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    let html = `<div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 15px; border-radius: 6px;">`;
                    html += `<p style="color: #065f46; font-weight: 600; margin-bottom: 8px;">‚úÖ Upload Conclu√≠do!</p>`;
                    html += `<p style="color: #047857; font-size: 14px;">Anexados: ${result.uploaded} / ${result.total}</p>`;
                    
                    // Mostrar detalhes dos uploads bem-sucedidos
                    if (result.details && result.details.length > 0) {
                        html += `<details style="margin-top: 10px;"><summary style="cursor: pointer; color: #047857;">‚úÖ ${result.details.length} PDFs anexados</summary>`;
                        html += `<ul style="margin-top: 8px; font-size: 12px; color: #065f46;">`;
                        result.details.forEach(detail => {
                            html += `<li>${detail.filename} ‚Üí ${detail.dr_number} (${(detail.size / 1024).toFixed(1)} KB)</li>`;
                        });
                        html += `</ul></details>`;
                    }
                    
                    // Mostrar erros se houver
                    if (result.errors && result.errors.length > 0) {
                        html += `<details style="margin-top: 10px;"><summary style="cursor: pointer; color: #dc2626;">‚ö†Ô∏è ${result.errors.length} erros</summary>`;
                        html += `<ul style="margin-top: 8px; font-size: 12px; color: #991b1b;">`;
                        result.errors.forEach(err => {
                            html += `<li>${err}</li>`;
                        });
                        html += `</ul></details>`;
                    }
                    
                    html += `</div>`;
                    statusDiv.innerHTML = html;
                    
                    showSuccessMessage(`${result.uploaded} PDFs anexados com sucesso!`);
                    
                    // Limpar input
                    fileInput.value = '';
                    document.getElementById('fileCount').textContent = 'Nenhum ficheiro selecionado';
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Error uploading PDFs:', error);
                statusDiv.innerHTML = `<div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 6px;">
                    <p style="color: #991b1b; font-weight: 600;">‚ùå Erro no Upload</p>
                    <p style="color: #dc2626; font-size: 14px; margin-top: 4px;">${error.message}</p>
                </div>`;
                showErrorMessage('Erro ao fazer upload: ' + error.message);
            }
        }

        async function uploadPdfToDR() {
            const drNumber = document.getElementById('pdfDrNumber').value.trim();
            const fileInput = document.getElementById('pdfFileInput');
            const file = fileInput.files[0];
            
            if (!drNumber) {
                showErrorMessage('Por favor indica o n√∫mero do DR');
                return;
            }
            
            if (!file) {
                showErrorMessage('Por favor seleciona um ficheiro PDF');
                return;
            }
            
            const statusDiv = document.getElementById('pdfUploadStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #6b7280;">üì§ A fazer upload...</p>';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`/api/damage-reports/upload-pdf/${encodeURIComponent(drNumber)}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    statusDiv.innerHTML = `<div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 15px; border-radius: 6px;">
                        <p style="color: #065f46; font-weight: 600;">‚úÖ PDF Anexado!</p>
                        <p style="color: #047857; font-size: 14px; margin-top: 4px;">${result.filename} (${(result.size / 1024).toFixed(1)} KB)</p>
                    </div>`;
                    
                    showSuccessMessage(`PDF anexado ao ${drNumber}`);
                    
                    // Limpar campos
                    document.getElementById('pdfDrNumber').value = '';
                    fileInput.value = '';
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Error uploading PDF:', error);
                statusDiv.innerHTML = `<div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 6px;">
                    <p style="color: #991b1b; font-weight: 600;">‚ùå Erro no Upload</p>
                    <p style="color: #dc2626; font-size: 14px; margin-top: 4px;">${error.message}</p>
                </div>`;
                showErrorMessage('Erro ao fazer upload: ' + error.message);
            }
        }

        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('importStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #6b7280;">üì§ A processar ficheiro...</p>';
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!data.reports || !Array.isArray(data.reports)) {
                    throw new Error('Formato inv√°lido. Esperado: { "reports": [...] }');
                }
                
                statusDiv.innerHTML = `<p style="color: #6b7280;">‚è≥ A importar ${data.reports.length} relat√≥rios...</p>`;
                
                const response = await fetch('/api/damage-reports/import-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    let html = `<div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 15px; border-radius: 6px;">`;
                    html += `<p style="color: #065f46; font-weight: 600; margin-bottom: 8px;">‚úÖ Importa√ß√£o Conclu√≠da!</p>`;
                    html += `<p style="color: #047857; font-size: 14px;">Importados: ${result.imported} / ${result.total}</p>`;
                    
                    if (result.errors && result.errors.length > 0) {
                        html += `<details style="margin-top: 10px;"><summary style="cursor: pointer; color: #dc2626;">‚ö†Ô∏è ${result.errors.length} erros</summary>`;
                        html += `<ul style="margin-top: 8px; font-size: 12px; color: #991b1b;">`;
                        result.errors.forEach(err => {
                            html += `<li>${err}</li>`;
                        });
                        html += `</ul></details>`;
                    }
                    
                    html += `</div>`;
                    statusDiv.innerHTML = html;
                    
                    showSuccessMessage(`${result.imported} Damage Reports importados com sucesso!`);
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Error importing:', error);
                statusDiv.innerHTML = `<div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 6px;">
                    <p style="color: #991b1b; font-weight: 600;">‚ùå Erro na Importa√ß√£o</p>
                    <p style="color: #dc2626; font-size: 14px; margin-top: 4px;">${error.message}</p>
                </div>`;
                showErrorMessage('Erro ao importar: ' + error.message);
            }
            
            // Limpar input
            event.target.value = '';
        }

        async function updateDRNumbering() {
            try {
                const prefix = document.getElementById('drPrefix').value || 'DR';
                const currentNumber = parseInt(document.getElementById('drCurrentNumber').value) || 1;
                
                const response = await fetch('/api/damage-reports/numbering/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prefix, current_number: currentNumber })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    document.getElementById('nextDRNumber').textContent = result.next_number;
                    showSuccessMessage('Numera√ß√£o atualizada! Pr√≥ximo DR: ' + result.next_number);
                } else {
                    showErrorMessage('Erro ao atualizar numera√ß√£o: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating DR numbering:', error);
                showErrorMessage('Erro ao atualizar numera√ß√£o');
            }
        }
    </script>
</body>
</html>
